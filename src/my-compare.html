<html><head></head><body><div hidden="" by-polymer-bundler=""><link rel="import" href="shaders/import-shaders.html"><dom-module id="compare-viewer-2d" assetpath="elements/"><template><style>:host{display:block;position:relative;}#container{left:0;right:0;top:0;bottom:0;position:absolute;overflow:hidden;}#overlay{left:0;right:0;top:0;bottom:0;position:absolute;width:100%;height:100%;overflow:hidden;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;pointer-events:none;}#overlay > div{z-index:1;color:#fff;position:absolute;margin:4px;padding:2px 10px;}.direction{font-size:16px;text-transform:uppercase;}.information{font-size:14px;}.top{top:0;text-align:center;}.bottom{bottom:0;text-align:center;}.left{left:0;text-align:left;}.right{right:0;text-align:right;}</style><div id="overlay"><div id="top" class="top direction"></div><div id="bottom" class="bottom direction"></div><div id="left" class="left direction"></div><div id="right" class="right direction"></div></div><div id="container"></div></template><script>var CompareViewer2D=function(_Polymer$Element){babelHelpers.inherits(CompareViewer2D,_Polymer$Element);babelHelpers.createClass(CompareViewer2D,null,[{key:"is",get:function get(){return"compare-viewer-2d"}},{key:"properties",get:function get(){return{showInformation:{type:Boolean,value:!1},animationFrameID:{type:Number,value:-1},orientation:{type:String,value:"default",observer:"_orientationChanged"},stackOrientation:{type:Number,value:0,notify:!0},stackIndex:{type:Number,notify:!0,observer:"_onStackIndexChanged"},stackMaxIndex:{type:Number},stackScene:{type:Object,value:{},observer:"_stackSceneChanged"},stackHelper:{type:Object,value:{}},stack2Scene:{type:Object,value:{},observer:"_stack2SceneChanged"},stack2Helper:{type:Object,value:{}},stackWindowWidth:{type:Number,observer:"_stackWindowWidthChanged"},stackWindowCenter:{type:Number,observer:"_stackWindowCenterChanged"},stack2WindowWidth:{type:Number,observer:"_stack2WindowWidthChanged"},stack2WindowCenter:{type:Number,observer:"_stack2WindowCenterChanged"},sceneLayerTextureTarget:{type:Object,value:{}},sceneLayer2TextureTarget:{type:Object,value:{}},offsetX:{type:Number,value:0,observer:"_offsetChanged"},offsetY:{type:Number,value:0,observer:"_offsetChanged"},offsetZ:{type:Number,value:0,observer:"_offsetChanged"},mixMode:{type:Number,value:2,observer:"_mixModeChanged"},sizeX:{type:Number},sizeY:{type:Number},mouseI:{type:Number},mouseJ:{type:Number},mouseK:{type:Number},mouseValue:{type:Number},contours:{type:Array,value:[]},clipPlane:{type:Object,value:{}},localizers:{type:Array,value:[],observer:"_localizersChanged"}}}}]);function CompareViewer2D(){var _this;babelHelpers.classCallCheck(this,CompareViewer2D);_this=babelHelpers.possibleConstructorReturn(this,(CompareViewer2D.__proto__||Object.getPrototypeOf(CompareViewer2D)).call(this));_this._onScrollBound=_this._onScroll.bind(babelHelpers.assertThisInitialized(_this));_this._onMouseMoveBound=_this._onMouseMove.bind(babelHelpers.assertThisInitialized(_this));_this._onDoubleClickBound=_this._onDoubleClick.bind(babelHelpers.assertThisInitialized(_this));return _this}babelHelpers.createClass(CompareViewer2D,[{key:"disconnectedCallback",value:function disconnectedCallback(){babelHelpers.get(CompareViewer2D.prototype.__proto__||Object.getPrototypeOf(CompareViewer2D.prototype),"disconnectedCallback",this).call(this);this._controls.removeEventListener("OnScroll",this._onScrollBound);this._container.removeEventListener("dblclick",this._onDoubleClickBound);this._container.removeEventListener("mousemove",this._onMouseMoveBound)}},{key:"connectedCallback",value:function connectedCallback(){babelHelpers.get(CompareViewer2D.prototype.__proto__||Object.getPrototypeOf(CompareViewer2D.prototype),"connectedCallback",this).call(this);if(this._controls!==void 0&&this._container!==void 0){this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound)}}},{key:"ready",value:function ready(){babelHelpers.get(CompareViewer2D.prototype.__proto__||Object.getPrototypeOf(CompareViewer2D.prototype),"ready",this).call(this);this._initViewer()}},{key:"_initViewer",value:function _initViewer(){this._container=this.$.container;this._slice=null;this._scene=null;this._scene2=null;this._clipPlane=null;this.stackHelper=null;this.stack2Helper=null;this.orientation="default";this._changed=!0;this._initScene();this._initCamera(1);this._initControls();this._initRenderer();this._initLocalizers();this._initContours();this._initLayerMix();this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound);var geometry=new THREE.BoxGeometry(200,200,200),material=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0})}},{key:"_initScene",value:function _initScene(){this._scene=new THREE.Scene;this._scene2=new THREE.Scene}},{key:"_initCamera",value:function _initCamera(){this._camera=new AMI.OrthographicCamera(this._container.clientWidth/-2,this._container.clientWidth/2,this._container.clientHeight/-2,this._container.clientHeight/2,1,1e3)}},{key:"_initControls",value:function _initControls(){var _this2=this;this._controls=new AMI.TrackballOrthoControl(this._camera,this._container);this._controls.staticMoving=!0;this._controls.noRotate=!0;this._controls.target.set(0,0,0);this._camera.controls=this._controls;this._controls.addEventListener("change",function(){_this2._changed=!0})}},{key:"_initRenderer",value:function _initRenderer(){this._renderer=new THREE.WebGLRenderer({antialias:!0});this._renderer.autoClear=!1;this._renderer.updateStyle=!0;this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(4342338);this._renderer.setSize(this._container.clientWidth,this._container.clientHeight);this._container.appendChild(this._renderer.domElement)}},{key:"_initLocalizers",value:function _initLocalizers(){this.localizerHelper=null;this.localizerScene=new THREE.Scene}},{key:"_initLayerMix",value:function _initLayerMix(){this.sceneLayerTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.sceneLayer2TextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.uniformsLayerMix=MixShadersUniform.uniforms();this.uniformsLayerMix.uTextureBackTest0.value=this.sceneLayerTextureTarget.texture;this.uniformsLayerMix.uTextureBackTest1.value=this.sceneLayer2TextureTarget.texture;this.uniformsLayerMix.uTrackMouse.value=1;this.uniformsLayerMix.uMouse.value=new THREE.Vector2(0,0);this.uniformsLayerMix.uMixMode.value=this.mixMode;var fls=new MixShaderFragment(this.uniformsLayerMix),vls=new AMI.LayerVertexShader;this.materialLayerMix=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:this.uniformsLayerMix,vertexShader:vls.compute(),fragmentShader:fls.compute(),transparent:!0});this.meshLayerMix=null;this.sceneLayerMix=new THREE.Scene}},{key:"_initContours",value:function _initContours(){this.clipPlane=new THREE.Plane(new THREE.Vector3(0,0,0),0);this._contourTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});var uniformsLayerMix=AMI.ContourUniformShader.uniforms();uniformsLayerMix.uTextureFilled.value=this._contourTextureTarget.texture;uniformsLayerMix.uWidth.value=1;uniformsLayerMix.uCanvasWidth.value=this._contourTextureTarget.width;uniformsLayerMix.uCanvasHeight.value=this._contourTextureTarget.height;var fls=new AMI.ContourFragmentShader(uniformsLayerMix),vls=new AMI.ContourVertexShader;this._contourMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:uniformsLayerMix,vertexShader:vls.compute(),fragmentShader:fls.compute(),transparent:!0,extensions:{derivatives:!0}});this._contourMesh=null;this._contourScene=new THREE.Scene}},{key:"startRenderingLoop",value:function startRenderingLoop(){this._animate()}},{key:"stopRenderingLoop",value:function stopRenderingLoop(){window.cancelAnimationFrame(this.animationFrameID);this.animationFrameID=void 0}},{key:"_animate",value:function _animate(){var _this3=this;this.animationFrameID=requestAnimationFrame(function(){_this3._animate()});this._controls.update();if(this._changed){this._renderer.clear();this._renderer.render(this._scene,this._camera,this.sceneLayer2TextureTarget,!0);this._renderer.render(this._scene2,this._camera,this.sceneLayerTextureTarget,!0);this._renderer.render(this.sceneLayerMix,this._camera);this._renderer.clearDepth();if(1<=this.contours.length&&this.stackHelper){this.contours.forEach(function(object){object.materialFront.clippingPlanes=[_this3.clipPlane];object.materialBack.clippingPlanes=[_this3.clipPlane];_this3._renderer.render(object.scene,_this3._camera,_this3._contourTextureTarget,!0);_this3._renderer.clearDepth();_this3._contourMaterial.uniforms.uWidth.value=object.selected?3:1;_this3._renderer.render(_this3._contourScene,_this3._camera)})}this._renderer.clearDepth();this._renderer.render(this.localizerScene,this._camera);this._changed=!1}}},{key:"_onStackIndexChanged",value:function _onStackIndexChanged(index){if(this.stackHelper){this.stackHelper.index=index;if(this.stack2Helper)this.stack2Helper.index=index;this._updateContours();this._updateClipPlane();this._updateLayerMix();this._updateLocalizer()}}},{key:"_localizersChanged",value:function _localizersChanged(localizers){if(localizers===void 0||0===localizers.length||null===this.localizerHelper){return}for(var c=0;c<localizers.length;c++){this.localizerHelper["plane"+(c+1)]=localizers[c].plane;this.localizerHelper["color"+(c+1)]=localizers[c].color}}},{key:"_updateLocalizer",value:function _updateLocalizer(){if(null===this.localizerHelper){var stack=this.stackHelper.stack,slice=this.stackHelper.slice,referencePlane=slice.cartesianEquation();this.localizerHelper=new AMI.LocalizerHelper(stack,slice.geometry,referencePlane);this.localizerHelper.canvasWidth=this._container.clientWidth;this.localizerHelper.canvasHeight=this._container.clientHeight;this.localizerScene.add(this.localizerHelper)}this.localizerHelper.referencePlane=this.stackHelper.slice.cartesianEquation();this.localizerHelper.geometry=this.stackHelper.slice.geometry}},{key:"_updateContours",value:function _updateContours(){if(this._contourMesh){this._contourScene.remove(this._contourMesh);this._contourMesh.material.dispose();this._contourMesh.material=null;this._contourMesh.geometry.dispose();this._contourMesh.geometry=null}this._contourMesh=new THREE.Mesh(this.stackHelper.slice.geometry,this._contourMaterial);this._contourMesh.applyMatrix(this.stackHelper.stack._ijk2LPS);this._contourScene.add(this._contourMesh)}},{key:"_updateLayerMix",value:function _updateLayerMix(){if(this.meshLayerMix){this.sceneLayerMix.remove(this.meshLayerMix);this.meshLayerMix.material.dispose();this.meshLayerMix.material=null;this.meshLayerMix.geometry.dispose();this.meshLayerMix.geometry=null}this.meshLayerMix=new THREE.Mesh(this.stackHelper.slice.geometry,this.materialLayerMix);this.meshLayerMix.applyMatrix(this.stackHelper.stack._ijk2LPS);this.sceneLayerMix.add(this.meshLayerMix)}},{key:"_updateClipPlane",value:function _updateClipPlane(){var stackHelper=this.stackHelper,camera=this._camera,vertices=stackHelper.slice.geometry.vertices,p1=new THREE.Vector3(vertices[0].x,vertices[0].y,vertices[0].z).applyMatrix4(stackHelper._stack.ijk2LPS),p2=new THREE.Vector3(vertices[1].x,vertices[1].y,vertices[1].z).applyMatrix4(stackHelper._stack.ijk2LPS),p3=new THREE.Vector3(vertices[2].x,vertices[2].y,vertices[2].z).applyMatrix4(stackHelper._stack.ijk2LPS);this.clipPlane.setFromCoplanarPoints(p1,p2,p3);var cameraDirection=new THREE.Vector3(1,1,1);cameraDirection.applyQuaternion(camera.quaternion);if(0<cameraDirection.dot(this.clipPlane.normal)){this.clipPlane.negate()}}},{key:"_stackSceneChanged",value:function _stackSceneChanged(stackScene){if(stackScene===void 0||null===stackScene||!stackScene.children){return}this._scene=stackScene;this.set("stackHelper",this._scene.children[0]);this.update()}},{key:"_stack2SceneChanged",value:function _stack2SceneChanged(stackScene){if(stackScene===void 0||null===stackScene||!stackScene.children){return}this._scene2=stackScene;this.set("stack2Helper",this._scene2.children[0]);this.update()}},{key:"update",value:function update(){if(this.stackHelper){var stack=this.stackHelper.stack;this.stackHelper.slice.canvasWidth=this._container.clientWidth;this.stackHelper.slice.canvasHeight=this._container.clientHeight;if(this.stack2Helper){this.stack2Helper.slice.canvasWidth=this._container.clientWidth;this.stack2Helper.slice.canvasHeight=this._container.clientHeight}var worldbb=stack.worldBoundingBox(),lpsDims=new THREE.Vector3((worldbb[1]-worldbb[0])/2,(worldbb[3]-worldbb[2])/2,(worldbb[5]-worldbb[4])/2),box={center:stack.worldCenter().clone(),halfDimensions:new THREE.Vector3(lpsDims.x+10,lpsDims.y+10,lpsDims.z+10)},canvas={width:this._container.clientWidth,height:this._container.clientHeight};this._camera.directions=[stack.xCosine,stack.yCosine,stack.zCosine];this._camera.box=box;this._camera.canvas=canvas;this._orientationChanged(this.orientation)}}},{key:"resize",value:function resize(){if(this.stackHelper){var height=this._container.clientHeight,width=this._container.clientWidth;this._camera.canvas={width:width,height:height};this._camera.fitBox(2,1);this.sceneLayerTextureTarget.setSize(width,height);this.sceneLayer2TextureTarget.setSize(width,height);this._renderer.setSize(width,height);this.stackHelper.slice.canvasWidth=width;this.stackHelper.slice.canvasHeight=height;this.stack2Helper.slice.canvasWidth=width;this.stack2Helper.slice.canvasHeight=height;this._contourTextureTarget.setSize(width,height);this._contourMaterial.uniforms.uCanvasWidth.value=width;this._contourMaterial.uniforms.uCanvasHeight.value=height;this.localizerHelper.canvasWidth=width;this.localizerHelper.canvasHeight=height}}},{key:"_orientationChanged",value:function _orientationChanged(orientation){if(orientation===void 0||""===orientation){return}if(this.stackHelper&&this.stackHelper.stack){this._camera.orientation=orientation;this._camera.update();this._camera.fitBox(2,1);this.stackOrientation=this._camera.stackOrientation;this.stackHelper.orientation=this.stackOrientation;if(this.stack2Helper)this.stack2Helper.orientation=this.stackOrientation;this.stackMaxIndex=this.stackHelper.orientationMaxIndex;this.stackIndex=Math.floor(this.stackMaxIndex/2);this.updateInformation();this.updateLabels(this._camera.directionsLabel,this.stackHelper.stack.modality)}}},{key:"updateLabels",value:function updateLabels(labels,modality){if("CR"===modality||"DX"===modality){return}this.$.top.innerHTML=labels[0];this.$.bottom.innerHTML=labels[1];this.$.right.innerHTML=labels[2];this.$.left.innerHTML=labels[3]}},{key:"updateInformation",value:function updateInformation(){var stack=this.stackHelper.stack,orientation=this.stackHelper.orientation;this.sizeX=stack._dimensionsIJK.getComponent((orientation+1)%2);this.sizeY=stack._dimensionsIJK.getComponent((orientation+2)%2)}},{key:"_stackWindowWidthChanged",value:function _stackWindowWidthChanged(width){this.set("stackHelper.slice.windowWidth",width);this._changed=!0}},{key:"_stackWindowCenterChanged",value:function _stackWindowCenterChanged(center){this.set("stackHelper.slice.windowCenter",center);this._changed=!0}},{key:"_stack2WindowWidthChanged",value:function _stack2WindowWidthChanged(width){this.set("stack2Helper.slice.windowWidth",width);this._changed=!0}},{key:"_stack2WindowCenterChanged",value:function _stack2WindowCenterChanged(center){this.set("stack2Helper.slice.windowCenter",center);this._changed=!0}},{key:"_offsetChanged",value:function _offsetChanged(){console.log(this.offsetX,this.offsetY,this.offsetZ)}},{key:"_mixModeChanged",value:function _mixModeChanged(){if(this.uniformsLayerMix!==void 0){this.uniformsLayerMix.uMixMode.value=this.mixMode;this._changed=!0}}},{key:"getContainerOffset",value:function getContainerOffset(){var _Mathround=Math.round,box=this._container.getBoundingClientRect(),body=document.body,docEl=document.documentElement,scrollTop=window.pageYOffset||docEl.scrollTop||body.scrollTop,scrollLeft=window.pageXOffset||docEl.scrollLeft||body.scrollLeft,clientTop=docEl.clientTop||body.clientTop||0,clientLeft=docEl.clientLeft||body.clientLeft||0,top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:_Mathround(top),left:_Mathround(left)}}},{key:"_onMouseMove",value:function _onMouseMove(event){if(event.shiftKey){var cOffset=this.getContainerOffset(),mouseX=2*((event.clientX-cOffset.left)/this._container.clientWidth)-1,mouseY=2*-((event.clientY-cOffset.top)/this._container.clientHeight)+1;this.uniformsLayerMix.uMouse.value=new THREE.Vector2(mouseX,mouseY);this._changed=!0}}},{key:"_onDoubleClick",value:function _onDoubleClick(event){var cOffset=this.getContainerOffset(),mouse={x:2*((event.clientX-cOffset.left)/this._container.clientWidth)-1,y:2*-((event.clientY-cOffset.top)/this._container.clientHeight)+1},raycaster=new THREE.Raycaster;raycaster.setFromCamera(mouse,this._camera);var intersects=raycaster.intersectObject(this._scene,!0);if(0<intersects.length){var ijk=AMI.StackModel.worldToData(this.stackHelper.stack,intersects[0].point);this.mouseI=ijk.x;this.mouseJ=ijk.y;this.mouseK=ijk.z;var goToEvent=new CustomEvent("goto",{detail:new THREE.Vector3(this.mouseI,this.mouseJ,this.mouseK)});this.dispatchEvent(goToEvent)}}},{key:"_onScroll",value:function _onScroll(event){if(0<event.delta){if(this.stackHelper.index>=this.stackHelper.orientationMaxIndex-1){return!1}this.stackHelper.index+=1;if(this.stack2Helper.index>=this.stack2Helper.orientationMaxIndex-1){return!1}this.stack2Helper.index+=1}else{if(0>=this.stackHelper.index){return!1}this.stackHelper.index-=1;if(0>=this.stack2Helper.index){return!1}this.stack2Helper.index-=1}this.stackIndex=this.stackHelper.index}}]);return CompareViewer2D}(Polymer.Element);window.customElements.define(CompareViewer2D.is,CompareViewer2D);</script></dom-module><link rel="import" href="elements/contours-list-item.html"><link rel="import" href="my-icons.html"><link rel="import" href="style/viewers-style.html"></div><dom-module id="my-compare"><template><style include="viewers-style">.buttons-list-3d{height:24px;padding:0;font-size:12px;color:#d9d9d9;position:absolute;top:5px;left:5px;z-index:1;cursor:default;font-weight:lighter;}.buttons-list-3d .button-3d{width:40px;height:40px;background-color:var(--dark-primary-color);color:var(--text-primary-color);}#modalControls{width:350px;}#modalControls > h2{padding:5px 30px;}#modalControls > p{padding:5px 30px;margin:0;}#modalControls .kbd{padding:0.1em 0.6em;border:1px solid #ccc;font-size:11px;font-family:Arial, Helvetica, sans-serif;background-color:#f7f7f7;color:#333;-moz-box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;-webkit-box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;display:inline-block;margin:0 0.1em;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap;}#modalControls .esc{font-size:11px;font-family:Arial, Helvetica, sans-serif;color:#333;display:inline-block;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap;}</style><firebase-auth id="FBAuth" user="{{user}}"></firebase-auth><firebase-query id="FBQuery" path="/cases" data="{{cases}}" equal-to="[[page]]"></firebase-query><firebase-query id="FBSave" path="/users/[[user.uid]]/cases"></firebase-query><app-drawer-layout fullbleed=""><app-drawer slot="drawer" hidden="[[loadingData]]"><div style="height:100% ; overflow-x:hidden ; overflow-y:auto;"><a href="home/"><div class="welcome"></div></a><div style="width:100%"><paper-listbox selected="{{filter}}" attr-for-selected="label" selectable=".label"><a href="data/[[userCase.id]]/"><paper-item class="" raised="">View data</paper-item></a><a href="case/[[userCase.id]]/"><paper-item class="" raised="">Open atlas</paper-item></a><a href="compare/[[userCase.id]]/"><paper-item class="iron-selected" raised="">Open compare</paper-item></a><contours-list-item contours="{{userCase.models}}" on-tap="_updateRenderers" on-mousemove="_updateRenderers"></contours-list-item></paper-listbox></div></div></app-drawer><app-header-layout has-scrolling-region=""><app-header slot="header" condenses="" reveals="" effects="waterfall"><app-toolbar><paper-icon-button icon="my-icons:menu" drawer-toggle=""></paper-icon-button><div main-title="">[[userCase.title]]</div><div class="emailTest"><div>{{user.email}}</div><a href="home/"><paper-icon-button icon="home"></paper-icon-button></a></div></app-toolbar></app-header><div class="viewers"><template is="dom-if" if="[[loadingData]]"><div class="loader"><div><div class="cube-wrapper"><div class="cube-folding"><span class="leaf1"></span> <span class="leaf2"></span> <span class="leaf3"></span> <span class="leaf4"></span></div><span class="loading" data-name="Loading">Loading ([[fetchProgress]]%)</span></div></div></div></template><div id="mainmain" class="main"><div class="advanced buttons-list-3d"><paper-icon-button icon="icons:touch-app" class="button-3d" on-tap="toggleControlModal"></paper-icon-button></div><div class="advanced fulloff"><div class="controls only-for-small"><span class="label">Image preview</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapseIP"></paper-icon-button></div><iron-collapse class="only-for-small" id="collapseIP" no-animation=""><div>Plane :<paper-dropdown-menu><paper-listbox slot="dropdown-content" selected="{{mainViewer}}"><paper-item>Axial</paper-item><paper-item>Coronal</paper-item><paper-item>Sagittal</paper-item></paper-listbox></paper-dropdown-menu></div></iron-collapse><div class="controls"><span class="label">Back image controls</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse"></paper-icon-button></div><iron-collapse id="collapse" no-animation=""><div>Win. Width:<paper-slider value="{{stackWindowWidth}}" immediate-value="{{stackWindowWidth}}" min="1" max="[[stackIntensityRange]]" secondary-progress="0"></paper-slider></div><div>Win. Level:<paper-slider value="{{stackWindowCenter}}" immediate-value="{{stackWindowCenter}}" min="[[stackIntensityMin]]" max="[[stackIntensityMax]]" secondary-progress="[[stackIntensityMin]]"></paper-slider></div><div><paper-button on-tap="_resetIntensity">Reset</paper-button></div></iron-collapse><div class="controls"><span class="label">Front image controls</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse2"></paper-icon-button></div><iron-collapse id="collapse2" no-animation=""><div>Win. Width:<paper-slider value="{{stack2WindowWidth}}" immediate-value="{{stack2WindowWidth}}" min="1" max="[[stack2IntensityRange]]" secondary-progress="0"></paper-slider></div><div>Win. Level:<paper-slider value="{{stack2WindowCenter}}" immediate-value="{{stack2WindowCenter}}" min="[[stack2IntensityMin]]" max="[[stack2IntensityMax]]" secondary-progress="[[stack2IntensityMin]]"></paper-slider></div><div><paper-button on-tap="_resetIntensity2">Reset</paper-button></div></iron-collapse><div class="controls"><span class="label">Mix images control</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse3"></paper-icon-button></div><iron-collapse id="collapse3" no-animation=""><div>Mode :<paper-dropdown-menu><paper-listbox slot="dropdown-content" selected="{{mixMode}}"><paper-item>Vertical</paper-item><paper-item>Horizontal</paper-item><paper-item>Cross</paper-item></paper-listbox></paper-dropdown-menu></div></iron-collapse></div><div id="p1" class="move"><div class="v2"><compare-viewer-2d id="first" class="viewer" stack-index="{{stackIndex0}}" stack-scene="[[stackScene0]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene0]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v0max]]" value="{{stackIndex0}}" immediate-value="{{stackIndex0}}"></paper-slider></div></div><div class="small"><div id="p2p2" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p2p2" on-tap="switchViewer"></paper-icon-button></div><div id="p2" class="move"><div class="v2"><compare-viewer-2d id="second" class="viewer" stack-index="{{stackIndex1}}" stack-scene="[[stackScene1]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene1]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v1max]]" value="{{stackIndex1}}" immediate-value="{{stackIndex1}}"></paper-slider></div></div><div id="p3p3" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p3p3" on-tap="switchViewer">Text</paper-icon-button></div><div id="p3" class="move"><div class="v2"><compare-viewer-2d id="third" class="viewer" stack-index="{{stackIndex2}}" stack-scene="[[stackScene2]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene2]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v2max]]" value="{{stackIndex2}}" immediate-value="{{stackIndex2}}"></paper-slider></div></div></div></div></app-header-layout></app-drawer-layout><paper-dialog id="modalControls"><h2>List of control</h2><p></p><ul><li class="kbd">shift</li><li class="esc">+ mouse : Fusion</li></ul><ul><li class="kbd">↑</li><li class="kbd">↓</li><li class="esc">: Change slice</li></ul><ul><li class="esc">Right click + mouse : Zoom-in</li><li class="esc"><iron-icon icon="icons:zoom-in"></iron-icon></li><li class="esc">and zoom-out<iron-icon icon="icons:zoom-out"></iron-icon></li></ul><ul><li class="esc">Left click + mouse : Grabe image</li></ul><ul><li class="esc">Double click : Fly to the mouse location</li></ul><p></p><div class="buttons"><paper-button dialog-confirm="" autofocus="">Close</paper-button></div></paper-dialog></template><script>var MyCompare=function(_Polymer$Element){babelHelpers.inherits(MyCompare,_Polymer$Element);babelHelpers.createClass(MyCompare,null,[{key:"is",get:function get(){return"my-compare"}},{key:"properties",get:function get(){return{routeData:{type:Object,value:{}},page:{type:String,reflectToAttribute:!0},user:{type:Object,value:{}},cases:{type:Array},userCase:{type:Object,observer:"_userCaseChanged"},contour:{type:String,value:"",observer:"_contourChanged"},choice:{type:String,value:""},mainViewer:{type:Number,value:0,observer:"_mainViewerChanged"},stackWindowWidth:{type:Number,value:0},stackWindowCenter:{type:Number,value:0},stackIntensityMin:{type:Number,value:0},stackIntensityMax:{type:Number,value:0},stackIntensityRange:{type:Number,value:0},stack2WindowWidth:{type:Number,value:0},stack2WindowCenter:{type:Number,value:0},stack2IntensityMin:{type:Number,value:0},stack2IntensityMax:{type:Number,value:0},stack2IntensityRange:{type:Number,value:0},mixMode:{type:Number,value:2},stackScene0:{type:Object,value:{}},stackScene1:{type:Object,value:{}},stackScene2:{type:Object,value:{}},stack2Scene0:{type:Object,value:{}},stack2Scene1:{type:Object,value:{}},stack2Scene2:{type:Object,value:{}},stackIndex0:{type:Number,observer:"_stackIndexChanged"},stackIndex1:{type:Number,observer:"_stackIndexChanged"},stackIndex2:{type:Number,observer:"_stackIndexChanged"},v0max:{type:Number,value:0},v1max:{type:Number,value:0},v2max:{type:Number,value:0},contours:{type:Array,value:[]},loadingData:{type:Boolean,value:!0},fetchProgress:{type:Number,value:0},answered:{type:Boolean,value:!1},todo:{type:Array,value:[],observer:"_todoChanged"}}}},{key:"observers",get:function get(){return["_routePageChanged(routeData.*)","_casesChanged(cases.splices)"]}}]);function MyCompare(){var _this;babelHelpers.classCallCheck(this,MyCompare);_this=babelHelpers.possibleConstructorReturn(this,(MyCompare.__proto__||Object.getPrototypeOf(MyCompare)).call(this));_this._resizeListenerBound=_this._resizeListener.bind(babelHelpers.assertThisInitialized(_this));return _this}babelHelpers.createClass(MyCompare,[{key:"connectedCallback",value:function connectedCallback(){babelHelpers.get(MyCompare.prototype.__proto__||Object.getPrototypeOf(MyCompare.prototype),"connectedCallback",this).call(this);window.addEventListener("resize",this._resizeListenerBound)}},{key:"disconnectedCallback",value:function disconnectedCallback(){babelHelpers.get(MyCompare.prototype.__proto__||Object.getPrototypeOf(MyCompare.prototype),"disconnectedCallback",this).call(this);window.removeEventListener("resize",this._resizeListenerBound)}},{key:"ready",value:function ready(){babelHelpers.get(MyCompare.prototype.__proto__||Object.getPrototypeOf(MyCompare.prototype),"ready",this).call(this)}},{key:"_routePageChanged",value:function _routePageChanged(routeData){if(routeData===void 0){return}this.contour=null;this.choice=null;if("compare"!==routeData.value.page){this.$.first.stopRenderingLoop();this.$.second.stopRenderingLoop();this.$.third.stopRenderingLoop();this.volumeLoader=null;return}this.page=routeData.value.subpage;this.$.first.startRenderingLoop();this.$.second.startRenderingLoop();this.$.third.startRenderingLoop()}},{key:"_casesChanged",value:function _casesChanged(cases){if(cases===void 0||1!==cases.indexSplices[0].object.length){return}console.log("my-comapre:_casesChanged",cases);this.set("userCase",cases.indexSplices[0].object[0])}},{key:"_contourChanged",value:function _contourChanged(contour){for(var i=0;i<this.contours.length;i++){this.contours[i].selected=this.contours[i].label===contour?!0:!1}this._updateRenderers()}},{key:"_userCaseChanged",value:function _userCaseChanged(userCase){var _this2=this;console.log("my-compare:_userCaseChanged userCase",userCase);if(null===userCase||!userCase.id){return}this._cleanup();var imageLoaded=!1;this.loadingData=!0;for(var loadContourModel=function(model){var extension=model.location.split(".").pop(),loader=null;if("vtk"===extension)loader=new THREE.VTKLoader;else if("stl"===extension)loader=new THREE.STLLoader;else{console.error("undefined contour file type "+model.location);return}loader.load(model.location,function(geometry){var object={scene:new THREE.Scene,materialFront:new THREE.MeshBasicMaterial({color:model.color,side:THREE.FrontSide,depthWrite:!0,opacity:0,transparent:!0,clippingPlanes:[]})};object.meshFront=new THREE.Mesh(geometry,object.materialFront);object.scene.add(object.meshFront);object.materialBack=new THREE.MeshBasicMaterial({color:model.color,side:THREE.BackSide,depthWrite:!0,opacity:1,transparent:!0,clippingPlanes:[]});object.meshBack=new THREE.Mesh(geometry,object.materialBack);object.scene.add(object.meshBack);_this2.push("contours",object);object.selected=!1;object.model=model;model.contour=object;if(3===_this2.contours.length&&imageLoaded){_this2.loadingData=!1;_this2._updateRenderers()}})},i=0;i<userCase.models.length;i++){userCase.models[i].id=i;userCase.models[i].visible=!0;loadContourModel(userCase.models[i])}this.volumeLoader=new AMI.VolumeLoader;var loaderFile1=0,loaderFile2=0;this.volumeLoader.on("fetch-start",function(evt){if(evt.file!==_this2.userCase.image.location&&evt.file!==_this2.userCase.image2.location)return;_this2.fetchProgress=0});this.volumeLoader.on("fetch-progress",function(evt){if(evt.file!==_this2.userCase.image.location&&evt.file!==_this2.userCase.image2.location)return;var progress=evt.loaded/evt.total;if(evt.file===userCase.image.location)loaderFile1=progress;else loaderFile2=progress;_this2.fetchProgress=Math.round(100*(loaderFile1+loaderFile2)/2)});this.volumeLoader.on("fetch-end",function(evt){if(evt.file!==_this2.userCase.image.location&&evt.file!==_this2.userCase.image2.location)return;_this2.fetchProgress=100});this.volumeLoader.load([userCase.image.location,userCase.image2.location]).then(function(series){console.log(series);var mergedSeries=series[0].mergeSeries(series);return mergedSeries}).then(function(series){if("compare"!==_this2.routeData.page){throw"page has changed"}if(_this2.userCase.image.location!==series[0]._seriesInstanceUID&&_this2.userCase.image2.location!==series[1]._seriesInstanceUID){throw"volume has changed !"}return series}).then(function(series){var _Mathfloor=Math.floor;console.log("my-compare:_userCaseChanged then series",series);var stack=series[0].stack[0],stackHelper0=new AMI.StackHelper(stack);stackHelper0.slice.intensityAuto=!1;stackHelper0.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper0.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene0=new THREE.Scene;stackScene0.add(stackHelper0);var stackHelper1=new AMI.StackHelper(stack);stackHelper1.slice.intensityAuto=!1;stackHelper1.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper1.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene1=new THREE.Scene;stackScene1.add(stackHelper1);var stackHelper2=new AMI.StackHelper(stack);stackHelper2.slice.intensityAuto=!1;stackHelper2.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper2.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene2=new THREE.Scene;stackScene2.add(stackHelper2);_this2.set("stackScene0",stackScene0);_this2.set("stackScene1",stackScene1);_this2.set("stackScene2",stackScene2);var stack2=series[1].stack[0],stack2Helper0=new AMI.StackHelper(stack2);stack2Helper0.slice.intensityAuto=!1;stack2Helper0.slice.windowWidth=_this2.userCase.image2.windowWidth;stack2Helper0.slice.windowCenter=_this2.userCase.image2.windowLevel;var stack2Scene0=new THREE.Scene;stack2Scene0.add(stack2Helper0);var stack2Helper1=new AMI.StackHelper(stack2);stack2Helper1.slice.intensityAuto=!1;stack2Helper1.slice.windowWidth=_this2.userCase.image2.windowWidth;stack2Helper1.slice.windowCenter=_this2.userCase.image2.windowLevel;var stack2Scene1=new THREE.Scene;stack2Scene1.add(stack2Helper1);var stack2Helper2=new AMI.StackHelper(stack2);stack2Helper2.slice.intensityAuto=!1;stack2Helper2.slice.windowWidth=_this2.userCase.image2.windowWidth;stack2Helper2.slice.windowCenter=_this2.userCase.image2.windowLevel;var stack2Scene2=new THREE.Scene;stack2Scene2.add(stack2Helper2);_this2.set("stack2Scene0",stack2Scene0);_this2.set("stack2Scene1",stack2Scene1);_this2.set("stack2Scene2",stack2Scene2);_this2.$.first.orientation="axial";_this2.$.first.resize();_this2.$.second.orientation="coronal";_this2.$.second.resize();_this2.$.third.orientation="sagittal";_this2.$.third.resize();_this2.v0max=_this2.$.first.stackMaxIndex;_this2.stackIndex0=_Mathfloor(_this2.v0max/2);_this2.v1max=_this2.$.second.stackMaxIndex;_this2.stackIndex1=_Mathfloor(_this2.v1max/2);_this2.v2max=_this2.$.third.stackMaxIndex;_this2.stackIndex2=_Mathfloor(_this2.v2max/2);_this2._resetIntensity();_this2._resetIntensity2();_this2.stackWindowWidth=_this2.userCase.image.windowWidth;_this2.stackWindowCenter=_this2.userCase.image.windowLevel;_this2.stack2WindowWidth=_this2.userCase.image2.windowWidth;_this2.stack2WindowCenter=_this2.userCase.image2.windowLevel;imageLoaded=!0;_this2.fetchProgress=0;_this2.answered=!1;if(imageLoaded){_this2.loadingData=!1;_this2._updateRenderers();if(_this2.userCase.image&&_this2.userCase.image.zoom){if(_this2.userCase.image.zoom.axial){_this2.$.first._camera.zoom=_this2.userCase.image.zoom.axial;_this2.$.first._camera.update()}if(_this2.userCase.image.zoom.coronal){_this2.$.second._camera.zoom=_this2.userCase.image.zoom.coronal;_this2.$.second._camera.update()}if(_this2.userCase.image.zoom.sagittal){_this2.$.third._camera.zoom=_this2.userCase.image.zoom.sagittal;_this2.$.third._camera.update()}}}})}},{key:"_resetIntensity",value:function _resetIntensity(){var stack=this.stackScene0.children[0].stack;this.stackIntensityMin=stack.minMax[0];this.stackIntensityMax=stack.minMax[1];this.stackIntensityRange=stack.minMax[1]-stack.minMax[0];this.stackWindowWidth=this.stackIntensityRange;this.stackWindowCenter=stack.minMax[0]+this.stackIntensityRange/2}},{key:"_resetIntensity2",value:function _resetIntensity2(){var stack=this.stack2Scene0.children[0].stack;this.stack2IntensityMin=stack.minMax[0];this.stack2IntensityMax=stack.minMax[1];this.stack2IntensityRange=stack.minMax[1]-stack.minMax[0];this.stack2WindowWidth=this.stack2IntensityRange;this.stack2WindowCenter=stack.minMax[0]+this.stack2IntensityRange/2}},{key:"_resizeListener",value:function _resizeListener(){this.$.first.resize();this.$.second.resize();this.$.third.resize();this._updateRenderers()}},{key:"_submitAnswer",value:function _submitAnswer(){this.$.FBSave.ref.push({id:this.userCase.id,contour:this.contour,choice:this.choice,date:Date.now()});this.contour="";this.choice="";this.answered=!0}},{key:"_selectionDone",value:function _selectionDone(contour,choice){return!(null!==contour&&""!==contour&&null!==choice&&""!==choice)}},{key:"_handleGoto",value:function _handleGoto(event){var ijk=event.detail,stackHelper0=this.stackScene0.children[0],stackHelper1=this.stackScene1.children[0],stackHelper2=this.stackScene2.children[0];this.$.first.stackIndex=ijk.getComponent((stackHelper0.orientation+2)%3);this.$.second.stackIndex=ijk.getComponent((stackHelper1.orientation+2)%3);this.$.third.stackIndex=ijk.getComponent((stackHelper2.orientation+2)%3);this._updateLocalizers();this._updateRenderers()}},{key:"_stackIndexChanged",value:function _stackIndexChanged(index){if(index===void 0){return}this._updateLocalizers();this._updateRenderers()}},{key:"_updateLocalizers",value:function _updateLocalizers(){if(this.stackScene0===void 0||this.stackScene0.children===void 0||this.stackScene1===void 0||this.stackScene1.children===void 0||this.stackScene2===void 0||this.stackScene2.children===void 0){return}var stackHelper0=this.stackScene0.children[0],stackHelper1=this.stackScene1.children[0],stackHelper2=this.stackScene2.children[0],plane0=stackHelper0.slice.cartesianEquation(),plane1=stackHelper1.slice.cartesianEquation(),plane2=stackHelper2.slice.cartesianEquation();this.$.first.localizers=[{plane:plane1,color:new THREE.Color("#607d8b")},{plane:plane2,color:new THREE.Color("#607d8b")}];this.$.second.localizers=[{plane:plane0,color:new THREE.Color("#607d8b")},{plane:plane2,color:new THREE.Color("#607d8b")}];this.$.third.localizers=[{plane:plane0,color:new THREE.Color("#607d8b")},{plane:plane1,color:new THREE.Color("#607d8b")}]}},{key:"_cleanup",value:function _cleanup(){if(null!==this.stackScene0&&this.stackScene0.children&&1<=this.stackScene0.children.length){var stackHelper=this.stackScene0.children[0];this.stackScene0.remove(stackHelper);stackHelper.dispose();stackHelper=null;this.stackScene0={}}if(null!==this.stackScene1&&this.stackScene1.children&&1<=this.stackScene1.children.length){var _stackHelper=this.stackScene1.children[0];this.stackScene1.remove(_stackHelper);_stackHelper.dispose();_stackHelper=null;this.stackScene1={}}if(null!==this.stackScene2&&this.stackScene2.children&&1<=this.stackScene2.children.length){var _stackHelper2=this.stackScene2.children[0];this.stackScene2.remove(_stackHelper2);_stackHelper2.dispose();_stackHelper2=null;this.stackScene2={}}if(this.contours&&0<this.contours.length){for(var i=0;i<this.contours.length;i++){this.contours[i].scene.remove(this.contours[i].meshFront);this.contours[i].meshFront.geometry.dispose();this.contours[i].meshFront.geometry=null;this.contours[i].meshFront.material.dispose();this.contours[i].meshFront.material=null;this.contours[i].meshFront=null;this.contours[i].scene.remove(this.contours[i].meshBack);this.contours[i].meshBack.geometry.dispose();this.contours[i].meshBack.geometry=null;this.contours[i].meshBack.material.dispose();this.contours[i].meshBack.material=null;this.contours[i].meshBack=null;this.set("contours",[])}for(var _i=0;_i<this.userCase.models.length;_i++){this.userCase.models[_i].contour=null}}}},{key:"switchViewer",value:function switchViewer(event){var target=event.currentTarget.getAttribute("target"),viewer=this.$[target].querySelector("compare-viewer-2d");if(null==viewer||viewer==void 0)return;var id=viewer.getAttribute("id");if(null==id||id==void 0)return;if("first"===id)this.set("mainViewer",0);else if("second"===id)this.set("mainViewer",1);else if("third"===id)this.set("mainViewer",2)}},{key:"_mainViewerChanged",value:function _mainViewerChanged(){var target=null;if(0==this.mainViewer)target="first";else if(1==this.mainViewer)target="second";else if(2==this.mainViewer)target="third";if(null==target)return;var elt=this.$[target].parentElement.parentElement.parentElement,id=elt.getAttribute("id");this._changeViewer(id)}},{key:"_changeViewer",value:function _changeViewer(target){var mainContainer=this.$.mainmain.children[2],smallContainer=this.$[target].children[1];this.$.mainmain.appendChild(smallContainer);this.$[target].appendChild(mainContainer);this._resizeListener()}},{key:"toggleControlModal",value:function toggleControlModal(){this.$.modalControls.open()}},{key:"toggleMenu",value:function toggleMenu(e){var target=e.currentTarget.getAttribute("target-menu");this.$[target].toggle()}},{key:"_updateRenderers",value:function _updateRenderers(){this.$.first._changed=!0;this.$.second._changed=!0;this.$.third._changed=!0}},{key:"_todoChanged",value:function _todoChanged(todo){if(todo===void 0){}}},{key:"_done",value:function _done(todo){return 0>=todo.length}},{key:"_next",value:function _next(todo){if(todo===void 0){return}if(0<todo.length){return todo[0].id}}}]);return MyCompare}(Polymer.Element);window.customElements.define(MyCompare.is,MyCompare);</script></dom-module></body></html>
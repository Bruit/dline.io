<html><head></head><body><div hidden="" by-polymer-bundler=""><script>var MixShaderFragment=function(){function a(b){babelHelpers.classCallCheck(this,a),this._uniforms=b,this._functions={},this._main=''}return babelHelpers.createClass(a,[{key:'functions',value:function(){''===this._main&&this.main();var a='';for(var b in this._functions)a+=this._functions[b]+'\n';return a}},{key:'uniforms',value:function(){var a='';for(var b in this._uniforms){var c=this._uniforms[b];a+='uniform '+c.typeGLSL+' '+b,c&&c.length&&(a+='['+c.length+']'),a+=';\n'}return a}},{key:'main',value:function(){this._main='\nvoid main(void) {\n\n    vec2 texc = vec2(((vProjectedCoords.x / vProjectedCoords.w) + 1.0 ) / 2.0,\n                    ((vProjectedCoords.y / vProjectedCoords.w) + 1.0 ) / 2.0 );\n  \n  //The back position is the world space position stored in the texture.\n  vec4 baseColor0 = texture2D(uTextureBackTest0, texc);\n  vec4 baseColor1 = texture2D(uTextureBackTest1, texc);\n  \n  if( uTrackMouse == 1 ){\n\n    if (uMixMode == 0) \n    {\n        if (vProjectedCoords.x > uMouse.x)\n        {\n            gl_FragColor = baseColor0;\n        }   \n        else\n        {\n            gl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n        }\n    }\n    else if (uMixMode == 1)\n    {\n        if (vProjectedCoords.y > uMouse.y)\n        {\n            gl_FragColor = baseColor0;\n        }   \n        else\n        {\n            gl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n        }\n    }\n    else // 2\n    {\n        if ( (vProjectedCoords.x > uMouse.x && vProjectedCoords.y > uMouse.y) \n        || (vProjectedCoords.x < uMouse.x && vProjectedCoords.y < uMouse.y) )\n        {\n            gl_FragColor = baseColor0;\n        }   \n        else\n        {\n            gl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n        }\n    }\n  }\n  else{\n\n    if( uType1 == 0 ){\n\n      //merge an image into\n      gl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n\n    }\n    else{\n\n      float opacity = baseColor1.a;\n      gl_FragColor = mix( baseColor0, baseColor1, opacity * uOpacity1 );\n\n    }\n\n  }\n\n  return;\n}\n   '}},{key:'compute',value:function(){return'\n// uniforms\n'+this.uniforms()+'\n\n// varying (should fetch it from vertex directly)\n// varying vec4      vPos;\nvarying vec4      vProjectedCoords;\n\n// tailored functions\n'+this.functions()+'\n\n// main loop\n'+this._main+'\n      '}}]),a}();</script><script>var MixShadersUniform=function(){function a(){babelHelpers.classCallCheck(this,a)}return babelHelpers.createClass(a,null,[{key:'uniforms',value:function(){return{uTextureBackTest0:{type:'t',value:[],typeGLSL:'sampler2D'},uTextureBackTest1:{type:'t',value:[],typeGLSL:'sampler2D'},uOpacity0:{type:'f',value:1,typeGLSL:'float'},uOpacity1:{type:'f',value:1,typeGLSL:'float'},uType0:{type:'i',value:0,typeGLSL:'int'},uType1:{type:'i',value:1,typeGLSL:'int'},uTrackMouse:{type:'i',value:0,typeGLSL:'int'},uMouse:{type:'v2',value:new THREE.Vector2,typeGLSL:'vec2'},uMixMode:{type:'i',value:0,typeGLSL:'int'},uShift:{type:'v2',value:new THREE.Vector2,typeGLSL:'vec2'},uCanvasWidth:{type:'f',value:0,typeGLSL:'float'},uCanvasHeight:{type:'f',value:0,typeGLSL:'float'}}}}]),a}();</script><dom-module id="compare-viewer-2d" assetpath="elements/"><template><style>:host{display:block;position:relative;}#container{left:0;right:0;top:0;bottom:0;position:absolute;overflow:hidden;}#overlay{left:0;right:0;top:0;bottom:0;position:absolute;width:100%;height:100%;overflow:hidden;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;pointer-events:none;}#overlay > div{z-index:1;color:#fff;position:absolute;margin:4px;padding:2px 10px;}.direction{font-size:16px;text-transform:uppercase;}.information{font-size:14px;}.top{top:0;text-align:center;}.bottom{bottom:0;text-align:center;}.left{left:0;text-align:left;}.right{right:0;text-align:right;}</style><div id="overlay"><div id="top" class="top direction"></div><div id="bottom" class="bottom direction"></div><div id="left" class="left direction"></div><div id="right" class="right direction"></div></div><div id="container"></div></template><script>var CompareViewer2D=function(a){function b(){babelHelpers.classCallCheck(this,b);var a=babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a._onScrollBound=a._onScroll.bind(a),a._onMouseMoveBound=a._onMouseMove.bind(a),a._onDoubleClickBound=a._onDoubleClick.bind(a),a}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,null,[{key:'is',get:function(){return'compare-viewer-2d'}},{key:'properties',get:function(){return{showInformation:{type:Boolean,value:!1},animationFrameID:{type:Number,value:-1},orientation:{type:String,value:'default',observer:'_orientationChanged'},stackOrientation:{type:Number,value:0,notify:!0},stackIndex:{type:Number,notify:!0,observer:'_onStackIndexChanged'},stackMaxIndex:{type:Number},stackScene:{type:Object,value:{},observer:'_stackSceneChanged'},stackHelper:{type:Object,value:{}},stack2Scene:{type:Object,value:{},observer:'_stack2SceneChanged'},stack2Helper:{type:Object,value:{}},stackWindowWidth:{type:Number,observer:'_stackWindowWidthChanged'},stackWindowCenter:{type:Number,observer:'_stackWindowCenterChanged'},stack2WindowWidth:{type:Number,observer:'_stack2WindowWidthChanged'},stack2WindowCenter:{type:Number,observer:'_stack2WindowCenterChanged'},sceneLayerTextureTarget:{type:Object,value:{}},sceneLayer2TextureTarget:{type:Object,value:{}},offsetX:{type:Number,value:0,observer:'_offsetChanged'},offsetY:{type:Number,value:0,observer:'_offsetChanged'},offsetZ:{type:Number,value:0,observer:'_offsetChanged'},mixMode:{type:Number,value:2,observer:'_mixModeChanged'},sizeX:{type:Number},sizeY:{type:Number},mouseI:{type:Number},mouseJ:{type:Number},mouseK:{type:Number},mouseValue:{type:Number},contours:{type:Array,value:[]},clipPlane:{type:Object,value:{}},localizers:{type:Array,value:[],observer:'_localizersChanged'}}}}]),babelHelpers.createClass(b,[{key:'disconnectedCallback',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'disconnectedCallback',this).call(this),this._controls.removeEventListener('OnScroll',this._onScrollBound),this._container.removeEventListener('dblclick',this._onDoubleClickBound),this._container.removeEventListener('mousemove',this._onMouseMoveBound)}},{key:'connectedCallback',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'connectedCallback',this).call(this),void 0!==this._controls&&void 0!==this._container&&(this._controls.addEventListener('OnScroll',this._onScrollBound),this._container.addEventListener('dblclick',this._onDoubleClickBound),this._container.addEventListener('mousemove',this._onMouseMoveBound))}},{key:'ready',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'ready',this).call(this),this._initViewer()}},{key:'_initViewer',value:function(){this._container=this.$.container,this._slice=null,this._scene=null,this._scene2=null,this._clipPlane=null,this.stackHelper=null,this.stack2Helper=null,this.orientation='default',this._changed=!0,this._initScene(),this._initCamera(1),this._initControls(),this._initRenderer(),this._initLocalizers(),this._initContours(),this._initLayerMix(),this._controls.addEventListener('OnScroll',this._onScrollBound),this._container.addEventListener('dblclick',this._onDoubleClickBound),this._container.addEventListener('mousemove',this._onMouseMoveBound);var a=new THREE.BoxGeometry(200,200,200),b=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0})}},{key:'_initScene',value:function(){this._scene=new THREE.Scene,this._scene2=new THREE.Scene}},{key:'_initCamera',value:function(){this._camera=new AMI.OrthographicCamera(this._container.clientWidth/-2,this._container.clientWidth/2,this._container.clientHeight/-2,this._container.clientHeight/2,1,1e3)}},{key:'_initControls',value:function(){var a=this;this._controls=new AMI.TrackballOrthoControl(this._camera,this._container),this._controls.staticMoving=!0,this._controls.noRotate=!0,this._controls.target.set(0,0,0),this._camera.controls=this._controls,this._controls.addEventListener('change',function(){a._changed=!0})}},{key:'_initRenderer',value:function(){this._renderer=new THREE.WebGLRenderer({antialias:!0}),this._renderer.autoClear=!1,this._renderer.updateStyle=!0,this._renderer.localClippingEnabled=!0,this._renderer.setClearColor(4342338),this._renderer.setSize(this._container.clientWidth,this._container.clientHeight),this._container.appendChild(this._renderer.domElement)}},{key:'_initLocalizers',value:function(){this.localizerHelper=null,this.localizerScene=new THREE.Scene}},{key:'_initLayerMix',value:function(){this.sceneLayerTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.sceneLayer2TextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.uniformsLayerMix=MixShadersUniform.uniforms(),this.uniformsLayerMix.uTextureBackTest0.value=this.sceneLayerTextureTarget.texture,this.uniformsLayerMix.uTextureBackTest1.value=this.sceneLayer2TextureTarget.texture,this.uniformsLayerMix.uTrackMouse.value=1,this.uniformsLayerMix.uMouse.value=new THREE.Vector2(0,0),this.uniformsLayerMix.uMixMode.value=this.mixMode;var a=new MixShaderFragment(this.uniformsLayerMix),b=new AMI.LayerVertexShader;this.materialLayerMix=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:this.uniformsLayerMix,vertexShader:b.compute(),fragmentShader:a.compute(),transparent:!0}),this.meshLayerMix=null,this.sceneLayerMix=new THREE.Scene}},{key:'_initContours',value:function(){this.clipPlane=new THREE.Plane(new THREE.Vector3(0,0,0),0),this._contourTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});var a=AMI.ContourUniformShader.uniforms();a.uTextureFilled.value=this._contourTextureTarget.texture,a.uWidth.value=1,a.uCanvasWidth.value=this._contourTextureTarget.width,a.uCanvasHeight.value=this._contourTextureTarget.height;var b=new AMI.ContourFragmentShader(a),c=new AMI.ContourVertexShader;this._contourMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:a,vertexShader:c.compute(),fragmentShader:b.compute(),transparent:!0,extensions:{derivatives:!0}}),this._contourMesh=null,this._contourScene=new THREE.Scene}},{key:'startRenderingLoop',value:function(){this._animate()}},{key:'stopRenderingLoop',value:function(){window.cancelAnimationFrame(this.animationFrameID),this.animationFrameID=void 0}},{key:'_animate',value:function(){var a=this;this.animationFrameID=requestAnimationFrame(function(){a._animate()}),this._controls.update(),this._changed&&(this._renderer.clear(),this._renderer.render(this._scene,this._camera,this.sceneLayer2TextureTarget,!0),this._renderer.render(this._scene2,this._camera,this.sceneLayerTextureTarget,!0),this._renderer.render(this.sceneLayerMix,this._camera),this._renderer.clearDepth(),1<=this.contours.length&&this.stackHelper&&this.contours.forEach(function(b){b.materialFront.clippingPlanes=[a.clipPlane],b.materialBack.clippingPlanes=[a.clipPlane],a._renderer.render(b.scene,a._camera,a._contourTextureTarget,!0),a._renderer.clearDepth(),a._contourMaterial.uniforms.uWidth.value=b.selected?3:1,a._renderer.render(a._contourScene,a._camera)}),this._renderer.clearDepth(),this._renderer.render(this.localizerScene,this._camera),this._changed=!1)}},{key:'_onStackIndexChanged',value:function(a){this.stackHelper&&(this.stackHelper.index=a,this.stack2Helper&&(this.stack2Helper.index=a),this._updateContours(),this._updateClipPlane(),this._updateLayerMix(),this._updateLocalizer())}},{key:'_localizersChanged',value:function(a){if(void 0!==a&&0!==a.length&&null!==this.localizerHelper)for(var b=0;b<a.length;b++)this.localizerHelper['plane'+(b+1)]=a[b].plane,this.localizerHelper['color'+(b+1)]=a[b].color}},{key:'_updateLocalizer',value:function(){if(null===this.localizerHelper){var a=this.stackHelper.stack,b=this.stackHelper.slice,c=b.cartesianEquation();this.localizerHelper=new AMI.LocalizerHelper(a,b.geometry,c),this.localizerHelper.canvasWidth=this._container.clientWidth,this.localizerHelper.canvasHeight=this._container.clientHeight,this.localizerScene.add(this.localizerHelper)}this.localizerHelper.referencePlane=this.stackHelper.slice.cartesianEquation(),this.localizerHelper.geometry=this.stackHelper.slice.geometry}},{key:'_updateContours',value:function(){this._contourMesh&&(this._contourScene.remove(this._contourMesh),this._contourMesh.material.dispose(),this._contourMesh.material=null,this._contourMesh.geometry.dispose(),this._contourMesh.geometry=null),this._contourMesh=new THREE.Mesh(this.stackHelper.slice.geometry,this._contourMaterial),this._contourMesh.applyMatrix(this.stackHelper.stack._ijk2LPS),this._contourScene.add(this._contourMesh)}},{key:'_updateLayerMix',value:function(){this.meshLayerMix&&(this.sceneLayerMix.remove(this.meshLayerMix),this.meshLayerMix.material.dispose(),this.meshLayerMix.material=null,this.meshLayerMix.geometry.dispose(),this.meshLayerMix.geometry=null),this.meshLayerMix=new THREE.Mesh(this.stackHelper.slice.geometry,this.materialLayerMix),this.meshLayerMix.applyMatrix(this.stackHelper.stack._ijk2LPS),this.sceneLayerMix.add(this.meshLayerMix)}},{key:'_updateClipPlane',value:function(){var a=this.stackHelper,b=this._camera,c=a.slice.geometry.vertices,d=new THREE.Vector3(c[0].x,c[0].y,c[0].z).applyMatrix4(a._stack.ijk2LPS),e=new THREE.Vector3(c[1].x,c[1].y,c[1].z).applyMatrix4(a._stack.ijk2LPS),f=new THREE.Vector3(c[2].x,c[2].y,c[2].z).applyMatrix4(a._stack.ijk2LPS);this.clipPlane.setFromCoplanarPoints(d,e,f);var g=new THREE.Vector3(1,1,1);g.applyQuaternion(b.quaternion),0<g.dot(this.clipPlane.normal)&&this.clipPlane.negate()}},{key:'_stackSceneChanged',value:function(a){void 0!==a&&null!==a&&a.children&&(this._scene=a,this.set('stackHelper',this._scene.children[0]),this.update())}},{key:'_stack2SceneChanged',value:function(a){void 0!==a&&null!==a&&a.children&&(this._scene2=a,this.set('stack2Helper',this._scene2.children[0]),this.update())}},{key:'update',value:function(){if(this.stackHelper){var a=this.stackHelper.stack;this.stackHelper.slice.canvasWidth=this._container.clientWidth,this.stackHelper.slice.canvasHeight=this._container.clientHeight,this.stack2Helper&&(this.stack2Helper.slice.canvasWidth=this._container.clientWidth,this.stack2Helper.slice.canvasHeight=this._container.clientHeight);var b=a.worldBoundingBox(),c=new THREE.Vector3((b[1]-b[0])/2,(b[3]-b[2])/2,(b[5]-b[4])/2),d={center:a.worldCenter().clone(),halfDimensions:new THREE.Vector3(c.x+10,c.y+10,c.z+10)},e={width:this._container.clientWidth,height:this._container.clientHeight};this._camera.directions=[a.xCosine,a.yCosine,a.zCosine],this._camera.box=d,this._camera.canvas=e,this._orientationChanged(this.orientation)}}},{key:'resize',value:function(){if(this.stackHelper){var a=this._container.clientHeight,b=this._container.clientWidth;this._camera.canvas={width:b,height:a},this._camera.fitBox(2,1),this.sceneLayerTextureTarget.setSize(b,a),this.sceneLayer2TextureTarget.setSize(b,a),this._renderer.setSize(b,a),this.stackHelper.slice.canvasWidth=b,this.stackHelper.slice.canvasHeight=a,this.stack2Helper.slice.canvasWidth=b,this.stack2Helper.slice.canvasHeight=a,this._contourTextureTarget.setSize(b,a),this._contourMaterial.uniforms.uCanvasWidth.value=b,this._contourMaterial.uniforms.uCanvasHeight.value=a,this.localizerHelper.canvasWidth=b,this.localizerHelper.canvasHeight=a}}},{key:'_orientationChanged',value:function(a){void 0===a||''===a||this.stackHelper&&this.stackHelper.stack&&(this._camera.orientation=a,this._camera.update(),this._camera.fitBox(2,1),this.stackOrientation=this._camera.stackOrientation,this.stackHelper.orientation=this.stackOrientation,this.stack2Helper&&(this.stack2Helper.orientation=this.stackOrientation),this.stackMaxIndex=this.stackHelper.orientationMaxIndex,this.stackIndex=Math.floor(this.stackMaxIndex/2),this.updateInformation(),this.updateLabels(this._camera.directionsLabel,this.stackHelper.stack.modality))}},{key:'updateLabels',value:function(a,b){'CR'===b||'DX'===b||(this.$.top.innerHTML=a[0],this.$.bottom.innerHTML=a[1],this.$.right.innerHTML=a[2],this.$.left.innerHTML=a[3])}},{key:'updateInformation',value:function(){var a=this.stackHelper.stack,b=this.stackHelper.orientation;this.sizeX=a._dimensionsIJK.getComponent((b+1)%2),this.sizeY=a._dimensionsIJK.getComponent((b+2)%2)}},{key:'_onDoubleClick',value:function(){var a=new CustomEvent('goto',{detail:new THREE.Vector3(this.mouseI,this.mouseJ,this.mouseK)});this.dispatchEvent(a)}},{key:'_onScroll',value:function(a){if(0<a.delta){if(this.stackHelper.index>=this.stackHelper.orientationMaxIndex-1)return!1;if(this.stackHelper.index+=1,this.stack2Helper.index>=this.stack2Helper.orientationMaxIndex-1)return!1;this.stack2Helper.index+=1}else{if(0>=this.stackHelper.index)return!1;if(this.stackHelper.index-=1,0>=this.stack2Helper.index)return!1;this.stack2Helper.index-=1}this.stackIndex=this.stackHelper.index}},{key:'_stackWindowWidthChanged',value:function(a){this.set('stackHelper.slice.windowWidth',a),this._changed=!0}},{key:'_stackWindowCenterChanged',value:function(a){this.set('stackHelper.slice.windowCenter',a),this._changed=!0}},{key:'_stack2WindowWidthChanged',value:function(a){this.set('stack2Helper.slice.windowWidth',a),this._changed=!0}},{key:'_stack2WindowCenterChanged',value:function(a){this.set('stack2Helper.slice.windowCenter',a),this._changed=!0}},{key:'_offsetChanged',value:function(){console.log(this.offsetX,this.offsetY,this.offsetZ)}},{key:'_mixModeChanged',value:function(){void 0!==this.uniformsLayerMix&&(this.uniformsLayerMix.uMixMode.value=this.mixMode,this._changed=!0)}},{key:'getContainerOffset',value:function(){var a=Math.round,b=this._container.getBoundingClientRect(),c=document.body,d=document.documentElement,e=window.pageYOffset||d.scrollTop||c.scrollTop,f=window.pageXOffset||d.scrollLeft||c.scrollLeft,g=d.clientTop||c.clientTop||0,h=d.clientLeft||c.clientLeft||0,i=b.top+e-g,j=b.left+f-h;return{top:a(i),left:a(j)}}},{key:'_onMouseMove',value:function(a){if(a.shiftKey){var b=this.getContainerOffset(),c=2*((a.clientX-b.left)/this._container.clientWidth)-1,d=2*-((a.clientY-b.top)/this._container.clientHeight)+1;this.uniformsLayerMix.uMouse.value=new THREE.Vector2(c,d),this._changed=!0}}}]),b}(Polymer.Element);window.customElements.define(CompareViewer2D.is,CompareViewer2D);</script></dom-module></div><dom-module id="my-compare"><template><style include="viewers-style"></style><firebase-auth id="FBAuth" user="{{user}}"></firebase-auth><firebase-query id="FBQuery" path="/cases" data="{{cases}}" equal-to="[[page]]"></firebase-query><firebase-query id="FBSave" path="/users/[[user.uid]]/cases"></firebase-query><app-drawer-layout fullbleed=""><app-drawer slot="drawer" hidden="[[loadingData]]"><div style="height:100% ; overflow-x:hidden ; overflow-y:auto;"><div class="welcome"></div><div style="width:100%"><paper-listbox selected="{{filter}}" attr-for-selected="label" selectable=".label"><a href="data/[[userCase.id]]/"><paper-item class="" raised="">View data</paper-item></a><a href="case/[[userCase.id]]/"><paper-item class="" raised="">Open atlas</paper-item></a><a href="compare/[[userCase.id]]/"><paper-item class="iron-selected" raised="">Open compare</paper-item></a><contours-list-item contours="{{userCase.models}}" on-tap="_updateRenderers" on-mousemove="_updateRenderers"></contours-list-item></paper-listbox></div></div></app-drawer><app-header-layout has-scrolling-region=""><app-header slot="header" condenses="" reveals="" effects="waterfall"><app-toolbar><paper-icon-button icon="my-icons:menu" drawer-toggle=""></paper-icon-button><div main-title="">[[userCase.title]]</div><div class="emailTest"><div>{{user.email}}</div><a href="home/"><paper-icon-button icon="home"></paper-icon-button></a></div></app-toolbar></app-header><div class="viewers"><template is="dom-if" if="[[loadingData]]"><div class="loader"><div><div class="cube-wrapper"><div class="cube-folding"><span class="leaf1"></span> <span class="leaf2"></span> <span class="leaf3"></span> <span class="leaf4"></span></div><span class="loading" data-name="Loading">Loading ([[fetchProgress]]%)</span></div></div></div></template><div id="mainmain" class="main"><div class="advanced fulloff"><div class="controls only-for-small"><span class="label">Image preview</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapseIP"></paper-icon-button></div><iron-collapse class="only-for-small" id="collapseIP" no-animation=""><div>Plane :<paper-dropdown-menu><paper-listbox slot="dropdown-content" selected="{{mainViewer}}"><paper-item>Axial</paper-item><paper-item>Coronal</paper-item><paper-item>Sagittal</paper-item></paper-listbox></paper-dropdown-menu></div></iron-collapse><div class="controls"><span class="label">Back image controls</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse"></paper-icon-button></div><iron-collapse id="collapse" no-animation=""><div>Win. Width:<paper-slider value="{{stackWindowWidth}}" immediate-value="{{stackWindowWidth}}" min="1" max="[[stackIntensityRange]]" secondary-progress="0"></paper-slider></div><div>Win. Level:<paper-slider value="{{stackWindowCenter}}" immediate-value="{{stackWindowCenter}}" min="[[stackIntensityMin]]" max="[[stackIntensityMax]]" secondary-progress="[[stackIntensityMin]]"></paper-slider></div><div><paper-button on-tap="_resetIntensity">Reset</paper-button></div></iron-collapse><div class="controls"><span class="label">Front image controls</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse2"></paper-icon-button></div><iron-collapse id="collapse2" no-animation=""><div>Win. Width:<paper-slider value="{{stack2WindowWidth}}" immediate-value="{{stack2WindowWidth}}" min="1" max="[[stack2IntensityRange]]" secondary-progress="0"></paper-slider></div><div>Win. Level:<paper-slider value="{{stack2WindowCenter}}" immediate-value="{{stack2WindowCenter}}" min="[[stack2IntensityMin]]" max="[[stack2IntensityMax]]" secondary-progress="[[stack2IntensityMin]]"></paper-slider></div><div><paper-button on-tap="_resetIntensity2">Reset</paper-button></div></iron-collapse><div class="controls"><span class="label">Mix images control</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse3"></paper-icon-button></div><iron-collapse id="collapse3" no-animation=""><div>Mode :<paper-dropdown-menu><paper-listbox slot="dropdown-content" selected="{{mixMode}}"><paper-item>Vertical</paper-item><paper-item>Horizontal</paper-item><paper-item>Cross</paper-item></paper-listbox></paper-dropdown-menu></div></iron-collapse></div><div id="p1" class="move"><div class="v2"><compare-viewer-2d id="first" class="viewer" stack-index="{{stackIndex0}}" stack-scene="[[stackScene0]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene0]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v0max]]" value="{{stackIndex0}}" immediate-value="{{stackIndex0}}"></paper-slider></div></div><div class="small"><div id="p2p2" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p2p2" on-tap="switchViewer"></paper-icon-button></div><div id="p2" class="move"><div class="v2"><compare-viewer-2d id="second" class="viewer" stack-index="{{stackIndex1}}" stack-scene="[[stackScene1]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene1]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v1max]]" value="{{stackIndex1}}" immediate-value="{{stackIndex1}}"></paper-slider></div></div><div id="p3p3" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p3p3" on-tap="switchViewer">Text</paper-icon-button></div><div id="p3" class="move"><div class="v2"><compare-viewer-2d id="third" class="viewer" stack-index="{{stackIndex2}}" stack-scene="[[stackScene2]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" stack2-scene="[[stack2Scene2]]" stack2-window-center="[[stack2WindowCenter]]" stack2-window-width="[[stack2WindowWidth]]" contours="[[contours]]" mix-mode="{{mixMode}}" on-goto="_handleGoto"></compare-viewer-2d></div><paper-slider min="0" max="[[v2max]]" value="{{stackIndex2}}" immediate-value="{{stackIndex2}}"></paper-slider></div></div></div></div></app-header-layout></app-drawer-layout></template><script>var MyCompare=function(a){function b(){babelHelpers.classCallCheck(this,b);var a=babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a._resizeListenerBound=a._resizeListener.bind(a),a}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,null,[{key:'is',get:function(){return'my-compare'}},{key:'properties',get:function(){return{routeData:{type:Object,value:{}},page:{type:String,reflectToAttribute:!0},user:{type:Object,value:{}},cases:{type:Array},userCase:{type:Object,observer:'_userCaseChanged'},contour:{type:String,value:'',observer:'_contourChanged'},choice:{type:String,value:''},mainViewer:{type:Number,value:0,observer:'_mainViewerChanged'},stackWindowWidth:{type:Number,value:0},stackWindowCenter:{type:Number,value:0},stackIntensityMin:{type:Number,value:0},stackIntensityMax:{type:Number,value:0},stackIntensityRange:{type:Number,value:0},stack2WindowWidth:{type:Number,value:0},stack2WindowCenter:{type:Number,value:0},stack2IntensityMin:{type:Number,value:0},stack2IntensityMax:{type:Number,value:0},stack2IntensityRange:{type:Number,value:0},mixMode:{type:Number,value:2},stackScene0:{type:Object,value:{}},stackScene1:{type:Object,value:{}},stackScene2:{type:Object,value:{}},stack2Scene0:{type:Object,value:{}},stack2Scene1:{type:Object,value:{}},stack2Scene2:{type:Object,value:{}},stackIndex0:{type:Number,observer:'_stackIndexChanged'},stackIndex1:{type:Number,observer:'_stackIndexChanged'},stackIndex2:{type:Number,observer:'_stackIndexChanged'},v0max:{type:Number,value:0},v1max:{type:Number,value:0},v2max:{type:Number,value:0},contours:{type:Array,value:[]},loadingData:{type:Boolean,value:!0},fetchProgress:{type:Number,value:0},answered:{type:Boolean,value:!1},todo:{type:Array,value:[],observer:'_todoChanged'}}}},{key:'observers',get:function(){return['_routePageChanged(routeData.*)','_casesChanged(cases.splices)']}}]),babelHelpers.createClass(b,[{key:'connectedCallback',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'connectedCallback',this).call(this),window.addEventListener('resize',this._resizeListenerBound)}},{key:'disconnectedCallback',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'disconnectedCallback',this).call(this),window.removeEventListener('resize',this._resizeListenerBound)}},{key:'ready',value:function(){babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'ready',this).call(this)}},{key:'_routePageChanged',value:function(a){if(void 0!==a)return this.contour=null,this.choice=null,'compare'===a.value.page?void(this.page=a.value.subpage,this.$.first.startRenderingLoop(),this.$.second.startRenderingLoop(),this.$.third.startRenderingLoop()):(this.$.first.stopRenderingLoop(),this.$.second.stopRenderingLoop(),this.$.third.stopRenderingLoop(),void(this.volumeLoader=null))}},{key:'_casesChanged',value:function(a){void 0===a||1!==a.indexSplices[0].object.length||(console.log('my-comapre:_casesChanged',a),this.set('userCase',a.indexSplices[0].object[0]))}},{key:'_contourChanged',value:function(a){for(var b=0;b<this.contours.length;b++)this.contours[b].selected=this.contours[b].label===a;this._updateRenderers()}},{key:'_userCaseChanged',value:function(a){var b=this;if(console.log('my-compare:_userCaseChanged userCase',a),null!==a&&a.id){this._cleanup();var c=!1;this.loadingData=!0;for(var d=function(a){var d=a.location.split('.').pop(),e=null;if('vtk'===d)e=new THREE.VTKLoader;else if('stl'===d)e=new THREE.STLLoader;else return void console.error('undefined contour file type '+a.location);e.load(a.location,function(d){var e={};e.scene=new THREE.Scene,e.materialFront=new THREE.MeshBasicMaterial({color:a.color,side:THREE.FrontSide,depthWrite:!0,opacity:0,transparent:!0,clippingPlanes:[]}),e.meshFront=new THREE.Mesh(d,e.materialFront),e.scene.add(e.meshFront),e.materialBack=new THREE.MeshBasicMaterial({color:a.color,side:THREE.BackSide,depthWrite:!0,opacity:1,transparent:!0,clippingPlanes:[]}),e.meshBack=new THREE.Mesh(d,e.materialBack),e.scene.add(e.meshBack),b.push('contours',e),e.selected=!1,e.model=a,a.contour=e,3===b.contours.length&&c&&(b.loadingData=!1,b._updateRenderers())})},e=0;e<a.models.length;e++)a.models[e].id=e,a.models[e].visible=!0,d(a.models[e]);this.volumeLoader=new AMI.VolumeLoader;var f=0,g=0;this.volumeLoader.on('fetch-start',function(a){a.file!==b.userCase.image.location&&a.file!==b.userCase.image2.location||(b.fetchProgress=0)}),this.volumeLoader.on('fetch-progress',function(c){if(c.file===b.userCase.image.location||c.file===b.userCase.image2.location){var d=c.loaded/c.total;c.file===a.image.location?f=d:g=d,b.fetchProgress=Math.round(100*(f+g)/2)}}),this.volumeLoader.on('fetch-end',function(a){a.file!==b.userCase.image.location&&a.file!==b.userCase.image2.location||(b.fetchProgress=100)}),this.volumeLoader.load([a.image.location,a.image2.location]).then(function(a){console.log(a);var b=a[0].mergeSeries(a);return b}).then(function(a){if('compare'!==b.routeData.page)throw'page has changed';if(b.userCase.image.location!==a[0]._seriesInstanceUID&&b.userCase.image2.location!==a[1]._seriesInstanceUID)throw'volume has changed !';return a}).then(function(a){var d=Math.floor;console.log('my-compare:_userCaseChanged then series',a);var e=a[0].stack[0],f=new AMI.StackHelper(e);f.slice.intensityAuto=!1,f.slice.windowWidth=b.userCase.image.windowWidth,f.slice.windowCenter=b.userCase.image.windowLevel;var g=new THREE.Scene;g.add(f);var h=new AMI.StackHelper(e);h.slice.intensityAuto=!1,h.slice.windowWidth=b.userCase.image.windowWidth,h.slice.windowCenter=b.userCase.image.windowLevel;var i=new THREE.Scene;i.add(h);var j=new AMI.StackHelper(e);j.slice.intensityAuto=!1,j.slice.windowWidth=b.userCase.image.windowWidth,j.slice.windowCenter=b.userCase.image.windowLevel;var k=new THREE.Scene;k.add(j),b.set('stackScene0',g),b.set('stackScene1',i),b.set('stackScene2',k);var l=a[1].stack[0],m=new AMI.StackHelper(l);m.slice.intensityAuto=!1,m.slice.windowWidth=b.userCase.image2.windowWidth,m.slice.windowCenter=b.userCase.image2.windowLevel;var n=new THREE.Scene;n.add(m);var o=new AMI.StackHelper(l);o.slice.intensityAuto=!1,o.slice.windowWidth=b.userCase.image2.windowWidth,o.slice.windowCenter=b.userCase.image2.windowLevel;var p=new THREE.Scene;p.add(o);var q=new AMI.StackHelper(l);q.slice.intensityAuto=!1,q.slice.windowWidth=b.userCase.image2.windowWidth,q.slice.windowCenter=b.userCase.image2.windowLevel;var r=new THREE.Scene;r.add(q),b.set('stack2Scene0',n),b.set('stack2Scene1',p),b.set('stack2Scene2',r),b.$.first.orientation='axial',b.$.first.resize(),b.$.second.orientation='coronal',b.$.second.resize(),b.$.third.orientation='sagittal',b.$.third.resize(),b.v0max=b.$.first.stackMaxIndex,b.stackIndex0=d(b.v0max/2),b.v1max=b.$.second.stackMaxIndex,b.stackIndex1=d(b.v1max/2),b.v2max=b.$.third.stackMaxIndex,b.stackIndex2=d(b.v2max/2),b._resetIntensity(),b._resetIntensity2(),b.stackWindowWidth=b.userCase.image.windowWidth,b.stackWindowCenter=b.userCase.image.windowLevel,b.stack2WindowWidth=b.userCase.image2.windowWidth,b.stack2WindowCenter=b.userCase.image2.windowLevel,c=!0,b.fetchProgress=0,b.answered=!1,c&&(b.loadingData=!1,b._updateRenderers())})}}},{key:'_resetIntensity',value:function(){var a=this.stackScene0.children[0].stack;this.stackIntensityMin=a.minMax[0],this.stackIntensityMax=a.minMax[1],this.stackIntensityRange=a.minMax[1]-a.minMax[0],this.stackWindowWidth=this.stackIntensityRange,this.stackWindowCenter=a.minMax[0]+this.stackIntensityRange/2}},{key:'_resetIntensity2',value:function(){var a=this.stack2Scene0.children[0].stack;this.stack2IntensityMin=a.minMax[0],this.stack2IntensityMax=a.minMax[1],this.stack2IntensityRange=a.minMax[1]-a.minMax[0],this.stack2WindowWidth=this.stack2IntensityRange,this.stack2WindowCenter=a.minMax[0]+this.stack2IntensityRange/2}},{key:'_resizeListener',value:function(){this.$.first.resize(),this.$.second.resize(),this.$.third.resize(),this._updateRenderers()}},{key:'_submitAnswer',value:function(){this.$.FBSave.ref.push({id:this.userCase.id,contour:this.contour,choice:this.choice,date:Date.now()}),this.contour='',this.choice='',this.answered=!0}},{key:'_selectionDone',value:function(a,b){return null===a||''===a||null===b||''===b}},{key:'_handleGoto',value:function(a){var b=a.detail,c=this.stackScene0.children[0],d=this.stackScene1.children[0],e=this.stackScene2.children[0];this.$.first.stackIndex=b.getComponent((c.orientation+2)%3),this.$.second.stackIndex=b.getComponent((d.orientation+2)%3),this.$.third.stackIndex=b.getComponent((e.orientation+2)%3),this._updateLocalizers(),this._updateRenderers()}},{key:'_stackIndexChanged',value:function(a){void 0===a||(this._updateLocalizers(),this._updateRenderers())}},{key:'_updateLocalizers',value:function(){if(void 0!==this.stackScene0&&void 0!==this.stackScene0.children&&void 0!==this.stackScene1&&void 0!==this.stackScene1.children&&void 0!==this.stackScene2&&void 0!==this.stackScene2.children){var a=this.stackScene0.children[0],b=this.stackScene1.children[0],c=this.stackScene2.children[0],d=a.slice.cartesianEquation(),e=b.slice.cartesianEquation(),f=c.slice.cartesianEquation();this.$.first.localizers=[{plane:e,color:new THREE.Color('#607d8b')},{plane:f,color:new THREE.Color('#607d8b')}],this.$.second.localizers=[{plane:d,color:new THREE.Color('#607d8b')},{plane:f,color:new THREE.Color('#607d8b')}],this.$.third.localizers=[{plane:d,color:new THREE.Color('#607d8b')},{plane:e,color:new THREE.Color('#607d8b')}]}}},{key:'_cleanup',value:function(){if(null!==this.stackScene0&&this.stackScene0.children&&1<=this.stackScene0.children.length){var a=this.stackScene0.children[0];this.stackScene0.remove(a),a.dispose(),a=null,this.stackScene0={}}if(null!==this.stackScene1&&this.stackScene1.children&&1<=this.stackScene1.children.length){var b=this.stackScene1.children[0];this.stackScene1.remove(b),b.dispose(),b=null,this.stackScene1={}}if(null!==this.stackScene2&&this.stackScene2.children&&1<=this.stackScene2.children.length){var c=this.stackScene2.children[0];this.stackScene2.remove(c),c.dispose(),c=null,this.stackScene2={}}if(this.contours&&0<this.contours.length){for(var d=0;d<this.contours.length;d++)this.contours[d].scene.remove(this.contours[d].meshFront),this.contours[d].meshFront.geometry.dispose(),this.contours[d].meshFront.geometry=null,this.contours[d].meshFront.material.dispose(),this.contours[d].meshFront.material=null,this.contours[d].meshFront=null,this.contours[d].scene.remove(this.contours[d].meshBack),this.contours[d].meshBack.geometry.dispose(),this.contours[d].meshBack.geometry=null,this.contours[d].meshBack.material.dispose(),this.contours[d].meshBack.material=null,this.contours[d].meshBack=null,this.set('contours',[]);for(var e=0;e<this.userCase.models.length;e++)this.userCase.models[e].contour=null}}},{key:'switchViewer',value:function(a){var b=a.currentTarget.getAttribute('target'),c=this.$[b].querySelector('compare-viewer-2d');if(null!=c&&void 0!=c){var d=c.getAttribute('id');null==d||void 0==d||('first'===d?this.set('mainViewer',0):'second'===d?this.set('mainViewer',1):'third'===d&&this.set('mainViewer',2))}}},{key:'_mainViewerChanged',value:function(){var a=null;if(0==this.mainViewer?a='first':1==this.mainViewer?a='second':2==this.mainViewer&&(a='third'),null!=a){var b=this.$[a].parentElement.parentElement.parentElement,c=b.getAttribute('id');this._changeViewer(c)}}},{key:'_changeViewer',value:function(a){var b=this.$.mainmain.children[1],c=this.$[a].children[1];this.$.mainmain.appendChild(c),this.$[a].appendChild(b),this._resizeListener()}},{key:'toggleMenu',value:function(a){var b=a.currentTarget.getAttribute('target-menu');this.$[b].toggle()}},{key:'_updateRenderers',value:function(){this.$.first._changed=!0,this.$.second._changed=!0,this.$.third._changed=!0}},{key:'_todoChanged',value:function(a){}},{key:'_done',value:function(a){return 0>=a.length}},{key:'_next',value:function(a){return void 0===a?void 0:0<a.length?a[0].id:void 0}}]),b}(Polymer.Element);window.customElements.define(MyCompare.is,MyCompare);</script></dom-module></body></html>
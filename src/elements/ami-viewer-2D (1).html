<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../import-ami.html"></head><body><dom-module id="ami-viewer-2d"><template><style>:host{display:block;position:relative;}#container{left:0;right:0;top:0;bottom:0;position:absolute;overflow:hidden;}#overlay{left:0;right:0;top:0;bottom:0;position:absolute;width:100%;height:100%;overflow:hidden;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;pointer-events:none;}#overlay > div{z-index:1;color:#fff;position:absolute;margin:4px;padding:2px 10px;}.direction{font-size:16px;text-transform:uppercase;}.information{font-size:14px;}.top{top:0;text-align:center;}.bottom{bottom:0;text-align:center;}.left{left:0;text-align:left;}.right{right:0;text-align:right;}</style><div id="overlay"><div id="top" class="top direction"></div><div id="bottom" class="bottom direction"></div><div id="left" class="left direction"></div><div id="right" class="right direction"></div></div><div id="container"></div></template><script>var AMIViewer2D=function(_Polymer$Element){babelHelpers.inherits(AMIViewer2D,_Polymer$Element);babelHelpers.createClass(AMIViewer2D,null,[{key:"is",get:function get(){return"ami-viewer-2d"}},{key:"properties",get:function get(){return{showInformation:{type:Boolean,value:!1},animationFrameID:{type:Number,value:-1},stackHelper:{type:Object,value:{}},stackScene:{type:Object,value:{},observer:"_stackSceneChanged"},orientation:{type:String,value:"default",observer:"_orientationChanged"},stackOrientation:{type:Number,value:0,notify:!0},stackIndex:{type:Number,notify:!0,observer:"_onStackIndexChanged"},stackMaxIndex:{type:Number},stackWindowWidth:{type:Number,observer:"_stackWindowWidthChanged"},stackWindowCenter:{type:Number,observer:"_stackWindowCenterChanged"},sizeX:{type:Number},sizeY:{type:Number},mouseI:{type:Number},mouseJ:{type:Number},mouseK:{type:Number},mouseValue:{type:Number},contours:{type:Array,value:[]},clipPlane:{type:Object,value:{}},localizers:{type:Array,value:[],observer:"_localizersChanged"}}}}]);function AMIViewer2D(){var _this;babelHelpers.classCallCheck(this,AMIViewer2D);_this=babelHelpers.possibleConstructorReturn(this,(AMIViewer2D.__proto__||Object.getPrototypeOf(AMIViewer2D)).call(this));_this._onScrollBound=_this._onScroll.bind(babelHelpers.assertThisInitialized(_this));_this._onMouseMoveBound=_this._onMouseMove.bind(babelHelpers.assertThisInitialized(_this));_this._onDoubleClickBound=_this._onDoubleClick.bind(babelHelpers.assertThisInitialized(_this));return _this}babelHelpers.createClass(AMIViewer2D,[{key:"disconnectedCallback",value:function disconnectedCallback(){babelHelpers.get(AMIViewer2D.prototype.__proto__||Object.getPrototypeOf(AMIViewer2D.prototype),"disconnectedCallback",this).call(this);this._controls.removeEventListener("OnScroll",this._onScrollBound);this._container.removeEventListener("dblclick",this._onDoubleClickBound);this._container.removeEventListener("mousemove",this._onMouseMoveBound)}},{key:"connectedCallback",value:function connectedCallback(){babelHelpers.get(AMIViewer2D.prototype.__proto__||Object.getPrototypeOf(AMIViewer2D.prototype),"connectedCallback",this).call(this);if(this._controls!==void 0&&this._container!==void 0){this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound)}}},{key:"ready",value:function ready(){babelHelpers.get(AMIViewer2D.prototype.__proto__||Object.getPrototypeOf(AMIViewer2D.prototype),"ready",this).call(this);this._initViewer()}},{key:"_initViewer",value:function _initViewer(){this._container=this.$.container;this._slice=null;this._scene=null;this._clipPlane=null;this.stackHelper=null;this.orientation="default";this._changed=!0;this._initScene();this._initCamera(1);this._initControls();this._initRenderer();this._initLocalizers();this._initContours();this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound);var geometry=new THREE.BoxGeometry(200,200,200),material=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0});this._mesh=new THREE.Mesh(geometry,material);this._scene.add(this._mesh)}},{key:"_initScene",value:function _initScene(){this._scene=new THREE.Scene}},{key:"_initCamera",value:function _initCamera(){this._camera=new AMI.OrthographicCamera(this._container.clientWidth/-2,this._container.clientWidth/2,this._container.clientHeight/-2,this._container.clientHeight/2,1,1e3)}},{key:"_initControls",value:function _initControls(){var _this2=this;this._controls=new AMI.TrackballOrthoControl(this._camera,this._container);this._controls.staticMoving=!0;this._controls.noRotate=!0;this._controls.target.set(0,0,0);this._camera.controls=this._controls;this._controls.addEventListener("change",function(){_this2._changed=!0})}},{key:"_initRenderer",value:function _initRenderer(){this._renderer=new THREE.WebGLRenderer({antialias:!0});this._renderer.autoClear=!1;this._renderer.updateStyle=!0;this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(4342338);this._renderer.setSize(this._container.clientWidth,this._container.clientHeight);this._container.appendChild(this._renderer.domElement)}},{key:"_initLocalizers",value:function _initLocalizers(){this.localizerHelper=null;this.localizerScene=new THREE.Scene}},{key:"_initContours",value:function _initContours(){this.clipPlane=new THREE.Plane(new THREE.Vector3(0,0,0),0);this._contourTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});var uniformsLayerMix=AMI.ContourUniformShader.uniforms();uniformsLayerMix.uTextureFilled.value=this._contourTextureTarget.texture;uniformsLayerMix.uWidth.value=1;uniformsLayerMix.uCanvasWidth.value=this._contourTextureTarget.width;uniformsLayerMix.uCanvasHeight.value=this._contourTextureTarget.height;var fls=new AMI.ContourFragmentShader(uniformsLayerMix),vls=new AMI.ContourVertexShader;this._contourMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:uniformsLayerMix,vertexShader:vls.compute(),fragmentShader:fls.compute(),transparent:!0,extensions:{derivatives:!0}});this._contourMesh=null;this._contourScene=new THREE.Scene}},{key:"startRenderingLoop",value:function startRenderingLoop(){this._animate()}},{key:"stopRenderingLoop",value:function stopRenderingLoop(){window.cancelAnimationFrame(this.animationFrameID);this.animationFrameID=void 0}},{key:"_animate",value:function _animate(){var _this3=this;this.animationFrameID=requestAnimationFrame(function(){_this3._animate()});this._controls.update();if(this._changed){this._renderer.clear();this._renderer.render(this._scene,this._camera);this._renderer.clearDepth();if(1<=this.contours.length&&this.stackHelper){this.contours.forEach(function(object){object.materialFront.clippingPlanes=[_this3.clipPlane];object.materialBack.clippingPlanes=[_this3.clipPlane];_this3._renderer.render(object.scene,_this3._camera,_this3._contourTextureTarget,!0);_this3._renderer.clearDepth();_this3._contourMaterial.uniforms.uWidth.value=object.selected?3:1;_this3._renderer.render(_this3._contourScene,_this3._camera)})}this._renderer.clearDepth();this._renderer.render(this.localizerScene,this._camera);this._changed=!1}}},{key:"_onStackIndexChanged",value:function _onStackIndexChanged(index){if(this.stackHelper){this.stackHelper.index=index;this._updateContours();this._updateClipPlane();this._updateLocalizer()}}},{key:"_localizersChanged",value:function _localizersChanged(localizers){if(localizers===void 0||0===localizers.length||null===this.localizerHelper){return}for(var c=0;c<localizers.length;c++){this.localizerHelper["plane"+(c+1)]=localizers[c].plane;this.localizerHelper["color"+(c+1)]=localizers[c].color}}},{key:"_updateLocalizer",value:function _updateLocalizer(){if(null===this.localizerHelper){var stack=this.stackHelper.stack,slice=this.stackHelper.slice,referencePlane=slice.cartesianEquation();this.localizerHelper=new AMI.LocalizerHelper(stack,slice.geometry,referencePlane);this.localizerHelper.canvasWidth=this._container.clientWidth;this.localizerHelper.canvasHeight=this._container.clientHeight;this.localizerScene.add(this.localizerHelper)}this.localizerHelper.referencePlane=this.stackHelper.slice.cartesianEquation();this.localizerHelper.geometry=this.stackHelper.slice.geometry}},{key:"_updateContours",value:function _updateContours(){if(this._contourMesh){this._contourScene.remove(this._contourMesh);this._contourMesh.material.dispose();this._contourMesh.material=null;this._contourMesh.geometry.dispose();this._contourMesh.geometry=null}this._contourMesh=new THREE.Mesh(this.stackHelper.slice.geometry,this._contourMaterial);this._contourMesh.applyMatrix(this.stackHelper.stack._ijk2LPS);this._contourScene.add(this._contourMesh)}},{key:"_updateClipPlane",value:function _updateClipPlane(){var stackHelper=this.stackHelper,camera=this._camera,vertices=stackHelper.slice.geometry.vertices,p1=new THREE.Vector3(vertices[0].x,vertices[0].y,vertices[0].z).applyMatrix4(stackHelper._stack.ijk2LPS),p2=new THREE.Vector3(vertices[1].x,vertices[1].y,vertices[1].z).applyMatrix4(stackHelper._stack.ijk2LPS),p3=new THREE.Vector3(vertices[2].x,vertices[2].y,vertices[2].z).applyMatrix4(stackHelper._stack.ijk2LPS);this.clipPlane.setFromCoplanarPoints(p1,p2,p3);var cameraDirection=new THREE.Vector3(1,1,1);cameraDirection.applyQuaternion(camera.quaternion);if(0<cameraDirection.dot(this.clipPlane.normal)){this.clipPlane.negate()}}},{key:"_stackSceneChanged",value:function _stackSceneChanged(stackScene){if(stackScene===void 0||null===stackScene||!stackScene.children){return}this._scene=stackScene;this.set("stackHelper",this._scene.children[0]);this.update()}},{key:"update",value:function update(){if(this.stackHelper){var stack=this.stackHelper.stack;this.stackHelper.slice.canvasWidth=this._container.clientWidth;this.stackHelper.slice.canvasHeight=this._container.clientHeight;var worldbb=stack.worldBoundingBox(),lpsDims=new THREE.Vector3((worldbb[1]-worldbb[0])/2,(worldbb[3]-worldbb[2])/2,(worldbb[5]-worldbb[4])/2),box={center:stack.worldCenter().clone(),halfDimensions:new THREE.Vector3(lpsDims.x+10,lpsDims.y+10,lpsDims.z+10)},canvas={width:this._container.clientWidth,height:this._container.clientHeight};this._camera.directions=[stack.xCosine,stack.yCosine,stack.zCosine];this._camera.box=box;this._camera.canvas=canvas;this._orientationChanged(this.orientation)}}},{key:"resize",value:function resize(){if(this.stackHelper){var height=this._container.clientHeight,width=this._container.clientWidth;this._camera.canvas={width:width,height:height};this._camera.fitBox(2,1);this._renderer.setSize(width,height);this.stackHelper.slice.canvasWidth=width;this.stackHelper.slice.canvasHeight=height;this._contourTextureTarget.setSize(width,height);this._contourMaterial.uniforms.uCanvasWidth.value=width;this._contourMaterial.uniforms.uCanvasHeight.value=height;this.localizerHelper.canvasWidth=width;this.localizerHelper.canvasHeight=height}}},{key:"_orientationChanged",value:function _orientationChanged(orientation){if(orientation===void 0||""===orientation){return}if(this.stackHelper&&this.stackHelper.stack){this._camera.orientation=orientation;this._camera.update();this._camera.fitBox(2,1);this.stackOrientation=this._camera.stackOrientation;this.stackHelper.orientation=this.stackOrientation;this.stackMaxIndex=this.stackHelper.orientationMaxIndex;this.stackIndex=Math.floor(this.stackMaxIndex/2);this.updateInformation();this.updateLabels(this._camera.directionsLabel,this.stackHelper.stack.modality)}}},{key:"updateLabels",value:function updateLabels(labels,modality){if("CR"===modality||"DX"===modality){return}this.$.top.innerHTML=labels[0];this.$.bottom.innerHTML=labels[1];this.$.right.innerHTML=labels[2];this.$.left.innerHTML=labels[3]}},{key:"updateInformation",value:function updateInformation(){var stack=this.stackHelper.stack,orientation=this.stackHelper.orientation;this.sizeX=stack._dimensionsIJK.getComponent((orientation+1)%2);this.sizeY=stack._dimensionsIJK.getComponent((orientation+2)%2)}},{key:"_onDoubleClick",value:function _onDoubleClick(){var goToEvent=new CustomEvent("goto",{detail:new THREE.Vector3(this.mouseI,this.mouseJ,this.mouseK)});this.dispatchEvent(goToEvent)}},{key:"_onScroll",value:function _onScroll(event){if(0<event.delta){if(this.stackHelper.index>=this.stackHelper.orientationMaxIndex-1){return!1}this.stackHelper.index+=1}else{if(0>=this.stackHelper.index){return!1}this.stackHelper.index-=1}this.stackIndex=this.stackHelper.index}},{key:"_stackWindowWidthChanged",value:function _stackWindowWidthChanged(width){this.set("stackHelper.slice.windowWidth",width);this._changed=!0}},{key:"_stackWindowCenterChanged",value:function _stackWindowCenterChanged(center){this.set("stackHelper.slice.windowCenter",center);this._changed=!0}},{key:"_onMouseMove",value:function _onMouseMove(event){var mouse={x:2*((event.clientX-this._container.offsetParent.offsetLeft-this._container.offsetParent.offsetParent.offsetLeft-this._container.offsetParent.offsetParent.offsetParent.offsetLeft-this._container.offsetParent.offsetParent.offsetParent.offsetParent.offsetLeft)/this._container.clientWidth)-1,y:2*-((event.clientY-this._container.offsetParent.offsetTop-this._container.offsetParent.offsetParent.offsetTop-this._container.offsetParent.offsetParent.offsetParent.offsetTop-this._container.offsetParent.offsetParent.offsetParent.offsetParent.offsetTop)/this._container.clientHeight)+1},raycaster=new THREE.Raycaster;raycaster.setFromCamera(mouse,this._camera);var closetContour=null,minDistance=Number.MAX_VALUE;this.contours.forEach(function(contour){var intersects=raycaster.intersectObject(contour.scene,!0);intersects.forEach(function(intersect){if(intersect.distance<minDistance&&"Mesh"===intersect.object.type&&contour.model.visible){minDistance=intersect.distance;closetContour=contour}})});this.contours.forEach(function(contour){contour.selected=!1});if(null!==closetContour){}}}]);return AMIViewer2D}(Polymer.Element);window.customElements.define(AMIViewer2D.is,AMIViewer2D);</script></dom-module></body></html>
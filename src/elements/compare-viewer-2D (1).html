<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../import-ami.html"><link rel="import" href="../shaders/import-shaders.html"></head><body><dom-module id="compare-viewer-2d"><template><style>:host{display:block;position:relative;}#container{left:0;right:0;top:0;bottom:0;position:absolute;overflow:hidden;}#overlay{left:0;right:0;top:0;bottom:0;position:absolute;width:100%;height:100%;overflow:hidden;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;pointer-events:none;}#overlay > div{z-index:1;color:#fff;position:absolute;margin:4px;padding:2px 10px;}.direction{font-size:16px;text-transform:uppercase;}.information{font-size:14px;}.top{top:0;text-align:center;}.bottom{bottom:0;text-align:center;}.left{left:0;text-align:left;}.right{right:0;text-align:right;}</style><div id="overlay"><div id="top" class="top direction"></div><div id="bottom" class="bottom direction"></div><div id="left" class="left direction"></div><div id="right" class="right direction"></div></div><div id="container"></div></template><script>class CompareViewer2D extends Polymer.Element{static get is(){return"compare-viewer-2d"}static get properties(){return{showInformation:{type:Boolean,value:!1},animationFrameID:{type:Number,value:-1},orientation:{type:String,value:"default",observer:"_orientationChanged"},stackOrientation:{type:Number,value:0,notify:!0},stackIndex:{type:Number,notify:!0,observer:"_onStackIndexChanged"},stackMaxIndex:{type:Number},stackScene:{type:Object,value:{},observer:"_stackSceneChanged"},stackHelper:{type:Object,value:{}},stack2Scene:{type:Object,value:{},observer:"_stack2SceneChanged"},stack2Helper:{type:Object,value:{}},stackWindowWidth:{type:Number,observer:"_stackWindowWidthChanged"},stackWindowCenter:{type:Number,observer:"_stackWindowCenterChanged"},stack2WindowWidth:{type:Number,observer:"_stack2WindowWidthChanged"},stack2WindowCenter:{type:Number,observer:"_stack2WindowCenterChanged"},sceneLayerTextureTarget:{type:Object,value:{}},sceneLayer2TextureTarget:{type:Object,value:{}},offsetX:{type:Number,value:0,observer:"_offsetChanged"},offsetY:{type:Number,value:0,observer:"_offsetChanged"},offsetZ:{type:Number,value:0,observer:"_offsetChanged"},mixMode:{type:Number,value:2,observer:"_mixModeChanged"},sizeX:{type:Number},sizeY:{type:Number},mouseI:{type:Number},mouseJ:{type:Number},mouseK:{type:Number},mouseValue:{type:Number},contours:{type:Array,value:[]},clipPlane:{type:Object,value:{}},localizers:{type:Array,value:[],observer:"_localizersChanged"}}}constructor(){super();this._onScrollBound=this._onScroll.bind(this);this._onMouseMoveBound=this._onMouseMove.bind(this);this._onDoubleClickBound=this._onDoubleClick.bind(this)}disconnectedCallback(){super.disconnectedCallback();this._controls.removeEventListener("OnScroll",this._onScrollBound);this._container.removeEventListener("dblclick",this._onDoubleClickBound);this._container.removeEventListener("mousemove",this._onMouseMoveBound)}connectedCallback(){super.connectedCallback();if(this._controls!==void 0&&this._container!==void 0){this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound)}}ready(){super.ready();this._initViewer()}_initViewer(){this._container=this.$.container;this._slice=null;this._scene=null;this._scene2=null;this._clipPlane=null;this.stackHelper=null;this.stack2Helper=null;this.orientation="default";this._changed=!0;this._initScene();this._initCamera(1);this._initControls();this._initRenderer();this._initLocalizers();this._initContours();this._initLayerMix();this._controls.addEventListener("OnScroll",this._onScrollBound);this._container.addEventListener("dblclick",this._onDoubleClickBound);this._container.addEventListener("mousemove",this._onMouseMoveBound);const geometry=new THREE.BoxGeometry(200,200,200),material=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0})}_initScene(){this._scene=new THREE.Scene;this._scene2=new THREE.Scene}_initCamera(){this._camera=new AMI.OrthographicCamera(this._container.clientWidth/-2,this._container.clientWidth/2,this._container.clientHeight/-2,this._container.clientHeight/2,1,1e3)}_initControls(){this._controls=new AMI.TrackballOrthoControl(this._camera,this._container);this._controls.staticMoving=!0;this._controls.noRotate=!0;this._controls.target.set(0,0,0);this._camera.controls=this._controls;this._controls.addEventListener("change",()=>{this._changed=!0})}_initRenderer(){this._renderer=new THREE.WebGLRenderer({antialias:!0});this._renderer.autoClear=!1;this._renderer.updateStyle=!0;this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(4342338);this._renderer.setSize(this._container.clientWidth,this._container.clientHeight);this._container.appendChild(this._renderer.domElement)}_initLocalizers(){this.localizerHelper=null;this.localizerScene=new THREE.Scene}_initLayerMix(){this.sceneLayerTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.sceneLayer2TextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});this.uniformsLayerMix=MixShadersUniform.uniforms();this.uniformsLayerMix.uTextureBackTest0.value=this.sceneLayerTextureTarget.texture;this.uniformsLayerMix.uTextureBackTest1.value=this.sceneLayer2TextureTarget.texture;this.uniformsLayerMix.uTrackMouse.value=1;this.uniformsLayerMix.uMouse.value=new THREE.Vector2(0,0);this.uniformsLayerMix.uMixMode.value=this.mixMode;let fls=new MixShaderFragment(this.uniformsLayerMix),vls=new AMI.LayerVertexShader;this.materialLayerMix=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:this.uniformsLayerMix,vertexShader:vls.compute(),fragmentShader:fls.compute(),transparent:!0});this.meshLayerMix=null;this.sceneLayerMix=new THREE.Scene}_initContours(){this.clipPlane=new THREE.Plane(new THREE.Vector3(0,0,0),0);this._contourTextureTarget=new THREE.WebGLRenderTarget(this._container.clientWidth,this._container.clientHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});const uniformsLayerMix=AMI.ContourUniformShader.uniforms();uniformsLayerMix.uTextureFilled.value=this._contourTextureTarget.texture;uniformsLayerMix.uWidth.value=1;uniformsLayerMix.uCanvasWidth.value=this._contourTextureTarget.width;uniformsLayerMix.uCanvasHeight.value=this._contourTextureTarget.height;const fls=new AMI.ContourFragmentShader(uniformsLayerMix),vls=new AMI.ContourVertexShader;this._contourMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:uniformsLayerMix,vertexShader:vls.compute(),fragmentShader:fls.compute(),transparent:!0,extensions:{derivatives:!0}});this._contourMesh=null;this._contourScene=new THREE.Scene}startRenderingLoop(){this._animate()}stopRenderingLoop(){window.cancelAnimationFrame(this.animationFrameID);this.animationFrameID=void 0}_animate(){this.animationFrameID=requestAnimationFrame(()=>{this._animate()});this._controls.update();if(this._changed){this._renderer.clear();this._renderer.render(this._scene,this._camera,this.sceneLayer2TextureTarget,!0);this._renderer.render(this._scene2,this._camera,this.sceneLayerTextureTarget,!0);this._renderer.render(this.sceneLayerMix,this._camera);this._renderer.clearDepth();if(1<=this.contours.length&&this.stackHelper){this.contours.forEach(object=>{object.materialFront.clippingPlanes=[this.clipPlane];object.materialBack.clippingPlanes=[this.clipPlane];this._renderer.render(object.scene,this._camera,this._contourTextureTarget,!0);this._renderer.clearDepth();this._contourMaterial.uniforms.uWidth.value=object.selected?3:1;this._renderer.render(this._contourScene,this._camera)})}this._renderer.clearDepth();this._renderer.render(this.localizerScene,this._camera);this._changed=!1}}_onStackIndexChanged(index){if(this.stackHelper){this.stackHelper.index=index;if(this.stack2Helper)this.stack2Helper.index=index;this._updateContours();this._updateClipPlane();this._updateLayerMix();this._updateLocalizer()}}_localizersChanged(localizers){if(localizers===void 0||0===localizers.length||null===this.localizerHelper){return}for(let c=0;c<localizers.length;c++){this.localizerHelper["plane"+(c+1)]=localizers[c].plane;this.localizerHelper["color"+(c+1)]=localizers[c].color}}_updateLocalizer(){if(null===this.localizerHelper){const stack=this.stackHelper.stack,slice=this.stackHelper.slice,referencePlane=slice.cartesianEquation();this.localizerHelper=new AMI.LocalizerHelper(stack,slice.geometry,referencePlane);this.localizerHelper.canvasWidth=this._container.clientWidth;this.localizerHelper.canvasHeight=this._container.clientHeight;this.localizerScene.add(this.localizerHelper)}this.localizerHelper.referencePlane=this.stackHelper.slice.cartesianEquation();this.localizerHelper.geometry=this.stackHelper.slice.geometry}_updateContours(){if(this._contourMesh){this._contourScene.remove(this._contourMesh);this._contourMesh.material.dispose();this._contourMesh.material=null;this._contourMesh.geometry.dispose();this._contourMesh.geometry=null}this._contourMesh=new THREE.Mesh(this.stackHelper.slice.geometry,this._contourMaterial);this._contourMesh.applyMatrix(this.stackHelper.stack._ijk2LPS);this._contourScene.add(this._contourMesh)}_updateLayerMix(){if(this.meshLayerMix){this.sceneLayerMix.remove(this.meshLayerMix);this.meshLayerMix.material.dispose();this.meshLayerMix.material=null;this.meshLayerMix.geometry.dispose();this.meshLayerMix.geometry=null}this.meshLayerMix=new THREE.Mesh(this.stackHelper.slice.geometry,this.materialLayerMix);this.meshLayerMix.applyMatrix(this.stackHelper.stack._ijk2LPS);this.sceneLayerMix.add(this.meshLayerMix)}_updateClipPlane(){const stackHelper=this.stackHelper,camera=this._camera;let vertices=stackHelper.slice.geometry.vertices,p1=new THREE.Vector3(vertices[0].x,vertices[0].y,vertices[0].z).applyMatrix4(stackHelper._stack.ijk2LPS),p2=new THREE.Vector3(vertices[1].x,vertices[1].y,vertices[1].z).applyMatrix4(stackHelper._stack.ijk2LPS),p3=new THREE.Vector3(vertices[2].x,vertices[2].y,vertices[2].z).applyMatrix4(stackHelper._stack.ijk2LPS);this.clipPlane.setFromCoplanarPoints(p1,p2,p3);let cameraDirection=new THREE.Vector3(1,1,1);cameraDirection.applyQuaternion(camera.quaternion);if(0<cameraDirection.dot(this.clipPlane.normal)){this.clipPlane.negate()}}_stackSceneChanged(stackScene){if(stackScene===void 0||null===stackScene||!stackScene.children){return}this._scene=stackScene;this.set("stackHelper",this._scene.children[0]);this.update()}_stack2SceneChanged(stackScene){if(stackScene===void 0||null===stackScene||!stackScene.children){return}this._scene2=stackScene;this.set("stack2Helper",this._scene2.children[0]);this.update()}update(){if(this.stackHelper){const stack=this.stackHelper.stack;this.stackHelper.slice.canvasWidth=this._container.clientWidth;this.stackHelper.slice.canvasHeight=this._container.clientHeight;if(this.stack2Helper){this.stack2Helper.slice.canvasWidth=this._container.clientWidth;this.stack2Helper.slice.canvasHeight=this._container.clientHeight}const worldbb=stack.worldBoundingBox(),lpsDims=new THREE.Vector3((worldbb[1]-worldbb[0])/2,(worldbb[3]-worldbb[2])/2,(worldbb[5]-worldbb[4])/2),box={center:stack.worldCenter().clone(),halfDimensions:new THREE.Vector3(lpsDims.x+10,lpsDims.y+10,lpsDims.z+10)},canvas={width:this._container.clientWidth,height:this._container.clientHeight};this._camera.directions=[stack.xCosine,stack.yCosine,stack.zCosine];this._camera.box=box;this._camera.canvas=canvas;this._orientationChanged(this.orientation)}}resize(){if(this.stackHelper){const height=this._container.clientHeight,width=this._container.clientWidth;this._camera.canvas={width:width,height:height};this._camera.fitBox(2,1);this.sceneLayerTextureTarget.setSize(width,height);this.sceneLayer2TextureTarget.setSize(width,height);this._renderer.setSize(width,height);this.stackHelper.slice.canvasWidth=width;this.stackHelper.slice.canvasHeight=height;this.stack2Helper.slice.canvasWidth=width;this.stack2Helper.slice.canvasHeight=height;this._contourTextureTarget.setSize(width,height);this._contourMaterial.uniforms.uCanvasWidth.value=width;this._contourMaterial.uniforms.uCanvasHeight.value=height;this.localizerHelper.canvasWidth=width;this.localizerHelper.canvasHeight=height}}_orientationChanged(orientation){if(orientation===void 0||""===orientation){return}if(this.stackHelper&&this.stackHelper.stack){this._camera.orientation=orientation;this._camera.update();this._camera.fitBox(2,1);this.stackOrientation=this._camera.stackOrientation;this.stackHelper.orientation=this.stackOrientation;if(this.stack2Helper)this.stack2Helper.orientation=this.stackOrientation;this.stackMaxIndex=this.stackHelper.orientationMaxIndex;this.stackIndex=Math.floor(this.stackMaxIndex/2);this.updateInformation();this.updateLabels(this._camera.directionsLabel,this.stackHelper.stack.modality)}}updateLabels(labels,modality){if("CR"===modality||"DX"===modality){return}this.$.top.innerHTML=labels[0];this.$.bottom.innerHTML=labels[1];this.$.right.innerHTML=labels[2];this.$.left.innerHTML=labels[3]}updateInformation(){const stack=this.stackHelper.stack,orientation=this.stackHelper.orientation;this.sizeX=stack._dimensionsIJK.getComponent((orientation+1)%2);this.sizeY=stack._dimensionsIJK.getComponent((orientation+2)%2)}_onDoubleClick(){const goToEvent=new CustomEvent("goto",{detail:new THREE.Vector3(this.mouseI,this.mouseJ,this.mouseK)});this.dispatchEvent(goToEvent)}_onScroll(event){if(0<event.delta){if(this.stackHelper.index>=this.stackHelper.orientationMaxIndex-1){return!1}this.stackHelper.index+=1;if(this.stack2Helper.index>=this.stack2Helper.orientationMaxIndex-1){return!1}this.stack2Helper.index+=1}else{if(0>=this.stackHelper.index){return!1}this.stackHelper.index-=1;if(0>=this.stack2Helper.index){return!1}this.stack2Helper.index-=1}this.stackIndex=this.stackHelper.index}_stackWindowWidthChanged(width){this.set("stackHelper.slice.windowWidth",width);this._changed=!0}_stackWindowCenterChanged(center){this.set("stackHelper.slice.windowCenter",center);this._changed=!0}_stack2WindowWidthChanged(width){this.set("stack2Helper.slice.windowWidth",width);this._changed=!0}_stack2WindowCenterChanged(center){this.set("stack2Helper.slice.windowCenter",center);this._changed=!0}_offsetChanged(){console.log(this.offsetX,this.offsetY,this.offsetZ)}_mixModeChanged(){if(this.uniformsLayerMix!==void 0){this.uniformsLayerMix.uMixMode.value=this.mixMode;this._changed=!0}}getContainerOffset(){var _Mathround=Math.round,box=this._container.getBoundingClientRect(),body=document.body,docEl=document.documentElement,scrollTop=window.pageYOffset||docEl.scrollTop||body.scrollTop,scrollLeft=window.pageXOffset||docEl.scrollLeft||body.scrollLeft,clientTop=docEl.clientTop||body.clientTop||0,clientLeft=docEl.clientLeft||body.clientLeft||0,top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:_Mathround(top),left:_Mathround(left)}}_onMouseMove(event){if(event.shiftKey){let cOffset=this.getContainerOffset(),mouseX=2*((event.clientX-cOffset.left)/this._container.clientWidth)-1,mouseY=2*-((event.clientY-cOffset.top)/this._container.clientHeight)+1;this.uniformsLayerMix.uMouse.value=new THREE.Vector2(mouseX,mouseY);this._changed=!0}}}window.customElements.define(CompareViewer2D.is,CompareViewer2D);</script></dom-module></body></html>
<html><head></head><body><div hidden="" by-polymer-bundler=""><link rel="import" href="elements/ami-viewer-2D.html"><link rel="import" href="elements/contours-list-item.html"><link rel="import" href="my-icons.html"><link rel="import" href="style/viewers-style.html"></div><dom-module id="my-case"><template><style include="viewers-style">.buttons-list-3d{height:24px;padding:0;font-size:12px;color:#d9d9d9;position:absolute;top:5px;left:5px;z-index:1;cursor:default;font-weight:lighter;}.buttons-list-3d .button-3d{width:40px;height:40px;background-color:var(--dark-primary-color);color:var(--text-primary-color);}#modalControls{width:350px;}#modalControls > h2{padding:5px 30px;}#modalControls > p{padding:5px 30px;margin:0;}#modalControls .kbd{padding:0.1em 0.6em;border:1px solid #ccc;font-size:11px;font-family:Arial, Helvetica, sans-serif;background-color:#f7f7f7;color:#333;-moz-box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;-webkit-box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;box-shadow:0 1px 0px rgba(0, 0, 0, 0.2), 0 0 0 2px #ffffff inset;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;display:inline-block;margin:0 0.1em;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap;}#modalControls .esc{font-size:11px;font-family:Arial, Helvetica, sans-serif;color:#333;display:inline-block;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap;}</style><firebase-auth id="FBAuth" user="{{user}}"></firebase-auth><firebase-query id="FBQuery" path="/cases" data="{{cases}}" equal-to="[[page]]"></firebase-query><firebase-query id="FBSave" path="/users/[[user.uid]]/cases"></firebase-query><firebase-query id="FBUser" path="/users/[[user.uid]]" data="{{userToto}}"></firebase-query><app-drawer-layout fullbleed=""><app-drawer slot="drawer" hidden="[[loadingData]]"><div style="height:100% ; overflow-x:hidden ; overflow-y:auto;"><a href="home/"><div class="welcome"></div></a><div style="width:100%"><paper-listbox selected="{{filter}}" attr-for-selected="label" selectable=".label"><a href="data/[[userCase.id]]/"><paper-item class="" raised="">View data</paper-item></a><a href="case/[[userCase.id]]/"><paper-item class="iron-selected" raised="">Open atlas</paper-item></a><template is="dom-if" if="{{userCase.image2}}"><a href="compare/[[userCase.id]]/"><paper-item class="" raised="">Open compare</paper-item></a></template><contours-list-item contours="{{userCase.models}}" on-tap="_updateRenderers" on-mousemove="_updateRenderers"></contours-list-item></paper-listbox></div></div></app-drawer><app-header-layout has-scrolling-region=""><app-header slot="header" condenses="" reveals="" effects="waterfall"><app-toolbar><paper-icon-button icon="my-icons:menu" drawer-toggle=""></paper-icon-button><div main-title="">[[userCase.title]]</div><div class="emailTest"><div>{{user.email}}</div><a href="home/"><paper-icon-button icon="home"></paper-icon-button></a></div></app-toolbar></app-header><div class="viewers"><template is="dom-if" if="[[loadingData]]"><div class="loader"><div><div class="cube-wrapper"><div class="cube-folding"><span class="leaf1"></span> <span class="leaf2"></span> <span class="leaf3"></span> <span class="leaf4"></span></div><span class="loading" data-name="Loading">Loading ([[fetchProgress]]%)</span></div></div></div></template><div id="mainmain" class="main"><div class="advanced buttons-list-3d"><paper-icon-button icon="icons:touch-app" class="button-3d" on-tap="toggleControlModal"></paper-icon-button></div><div class="advanced fulloff"><div class="controls only-for-small"><span class="label">Image preview</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapseIP"></paper-icon-button></div><iron-collapse class="only-for-small" id="collapseIP" no-animation=""><div>Plane :<paper-dropdown-menu><paper-listbox slot="dropdown-content" selected="{{mainViewer}}"><paper-item>Axial</paper-item><paper-item>Coronal</paper-item><paper-item>Sagittal</paper-item></paper-listbox></paper-dropdown-menu></div></iron-collapse><div class="controls"><span class="label">Controls</span><paper-icon-button icon="my-icons:expand-more" target="p3p3" on-tap="toggleMenu" target-menu="collapse"></paper-icon-button></div><iron-collapse id="collapse" no-animation=""><div>Win. Width:<paper-slider value="{{stackWindowWidth}}" immediate-value="{{stackWindowWidth}}" min="1" max="[[stackIntensityRange]]" secondary-progress="0"></paper-slider></div><div>Win. Level:<paper-slider value="{{stackWindowCenter}}" immediate-value="{{stackWindowCenter}}" min="[[stackIntensityMin]]" max="[[stackIntensityMax]]" secondary-progress="[[stackIntensityMin]]"></paper-slider></div><div><paper-button on-tap="_resetIntensity">Reset</paper-button></div></iron-collapse></div><div id="p1" class="move"><div class="v2"><ami-viewer-2d id="first" class="viewer" stack-index="{{stackIndex0}}" stack-scene="[[stackScene0]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" contours="[[contours]]" on-goto="_handleGoto"></ami-viewer-2d></div><paper-slider min="0" max="[[v0max]]" value="{{stackIndex0}}" immediate-value="{{stackIndex0}}"></paper-slider></div></div><div class="small"><div id="p2p2" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p2p2" on-tap="switchViewer"></paper-icon-button></div><div id="p2" class="move"><div class="v2"><ami-viewer-2d id="second" class="viewer" stack-index="{{stackIndex1}}" stack-scene="[[stackScene1]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" contours="[[contours]]" on-goto="_handleGoto"></ami-viewer-2d></div><paper-slider min="0" max="[[v1max]]" value="{{stackIndex1}}" immediate-value="{{stackIndex1}}"></paper-slider></div></div><div id="p3p3" class="s2"><div class="fulloff"><span class="label">Fullscreen</span><paper-icon-button icon="fullscreen" target="p3p3" on-tap="switchViewer">Text</paper-icon-button></div><div id="p3" class="move"><div class="v2"><ami-viewer-2d id="third" class="viewer" stack-index="{{stackIndex2}}" stack-scene="[[stackScene2]]" stack-window-center="[[stackWindowCenter]]" stack-window-width="[[stackWindowWidth]]" contours="[[contours]]" on-goto="_handleGoto"></ami-viewer-2d></div><paper-slider min="0" max="[[v2max]]" value="{{stackIndex2}}" immediate-value="{{stackIndex2}}"></paper-slider></div></div></div></div></app-header-layout></app-drawer-layout><paper-dialog id="modalControls"><h2>List of control</h2><p></p><ul><li class="kbd">shift</li><li class="esc">+ mouse : Fusion</li></ul><ul><li class="kbd">↑</li><li class="kbd">↓</li><li class="esc">: Change slice</li></ul><ul><li class="esc">Right click + mouse : Zoom-in</li><li class="esc"><iron-icon icon="icons:zoom-in"></iron-icon></li><li class="esc">and zoom-out<iron-icon icon="icons:zoom-out"></iron-icon></li></ul><ul><li class="esc">Left click + mouse : Grabe image</li></ul><ul><li class="esc">Double click : Fly to the mouse location</li></ul><p></p><div class="buttons"><paper-button dialog-confirm="" autofocus="">Close</paper-button></div></paper-dialog></template><script>var MyCase=function(_Polymer$Element){babelHelpers.inherits(MyCase,_Polymer$Element);babelHelpers.createClass(MyCase,null,[{key:"is",get:function get(){return"my-case"}},{key:"properties",get:function get(){return{userToto:{type:Object,observer:"_userTotoChanged"},routeData:{type:Object,value:{}},page:{type:String,reflectToAttribute:!0},user:{type:Object,value:{}},cases:{type:Array},userCase:{type:Object,observer:"_userCaseChanged"},contour:{type:String,value:"",observer:"_contourChanged"},choice:{type:String,value:""},mainViewer:{type:Number,value:0,observer:"_mainViewerChanged"},series:{type:Object,value:{}},stack:{type:Object,value:{}},stackWindowWidth:{type:Number,value:0},stackWindowCenter:{type:Number,value:0},stackIntensityMin:{type:Number,value:0},stackIntensityMax:{type:Number,value:0},stackIntensityRange:{type:Number,value:0},stackScene0:{type:Object,value:{}},stackIndex0:{type:Number,observer:"_stackIndexChanged"},v0max:{type:Number,value:0},stackScene1:{type:Object,value:{}},stackIndex1:{type:Number,observer:"_stackIndexChanged"},v1max:{type:Number,value:0},stackScene2:{type:Object,value:{}},stackIndex2:{type:Number,observer:"_stackIndexChanged"},v2max:{type:Number,value:0},contours:{type:Array,value:[]},loadingData:{type:Boolean,value:!0},fetchProgress:{type:Number,value:0},answered:{type:Boolean,value:!1},todo:{type:Array,value:[],observer:"_todoChanged"}}}},{key:"observers",get:function get(){return["_routePageChanged(routeData.*)","_casesChanged(cases.splices)"]}}]);function MyCase(){var _this;babelHelpers.classCallCheck(this,MyCase);_this=babelHelpers.possibleConstructorReturn(this,(MyCase.__proto__||Object.getPrototypeOf(MyCase)).call(this));_this._resizeListenerBound=_this._resizeListener.bind(babelHelpers.assertThisInitialized(_this));return _this}babelHelpers.createClass(MyCase,[{key:"connectedCallback",value:function connectedCallback(){babelHelpers.get(MyCase.prototype.__proto__||Object.getPrototypeOf(MyCase.prototype),"connectedCallback",this).call(this);window.addEventListener("resize",this._resizeListenerBound)}},{key:"disconnectedCallback",value:function disconnectedCallback(){babelHelpers.get(MyCase.prototype.__proto__||Object.getPrototypeOf(MyCase.prototype),"disconnectedCallback",this).call(this);window.removeEventListener("resize",this._resizeListenerBound)}},{key:"ready",value:function ready(){babelHelpers.get(MyCase.prototype.__proto__||Object.getPrototypeOf(MyCase.prototype),"ready",this).call(this)}},{key:"_userTotoChanged",value:function _userTotoChanged(userToto){console.log(userToto)}},{key:"_routePageChanged",value:function _routePageChanged(routeData){if(routeData===void 0){return}this.contour=null;this.choice=null;if("case"!==routeData.value.page){this.$.first.stopRenderingLoop();this.$.second.stopRenderingLoop();this.$.third.stopRenderingLoop();return}this.page=routeData.value.subpage;this.$.first.startRenderingLoop();this.$.second.startRenderingLoop();this.$.third.startRenderingLoop()}},{key:"_casesChanged",value:function _casesChanged(cases){if(cases===void 0||1!==cases.indexSplices[0].object.length){return}console.log("my-case:_casesChanged",cases);this.set("userCase",cases.indexSplices[0].object[0])}},{key:"_contourChanged",value:function _contourChanged(contour){for(var i=0;i<this.contours.length;i++){this.contours[i].selected=this.contours[i].label===contour?!0:!1}this._updateRenderers()}},{key:"_userCaseChanged",value:function _userCaseChanged(userCase){var _this2=this;if(null===userCase||!userCase.id){return}this._cleanup();var imageLoaded=!1;this.loadingData=!0;for(var loadVTKObject=function(model){var vtkLoader=new THREE.VTKLoader;vtkLoader.load(model.location,function(geometry){var object={scene:new THREE.Scene,materialFront:new THREE.MeshBasicMaterial({color:model.color,side:THREE.FrontSide,depthWrite:!0,opacity:0,transparent:!0,clippingPlanes:[]})};object.meshFront=new THREE.Mesh(geometry,object.materialFront);object.scene.add(object.meshFront);object.materialBack=new THREE.MeshBasicMaterial({color:model.color,side:THREE.BackSide,depthWrite:!0,opacity:1,transparent:!0,clippingPlanes:[]});object.meshBack=new THREE.Mesh(geometry,object.materialBack);object.scene.add(object.meshBack);_this2.push("contours",object);object.selected=!1;object.model=model;model.contour=object;if(3===_this2.contours.length&&imageLoaded){_this2.loadingData=!1;_this2._updateRenderers()}},function(){})},i=0;i<userCase.models.length;i++){userCase.models[i].id=i;userCase.models[i].visible=!0;loadVTKObject(userCase.models[i])}console.log("my-case:_userCaseChanged contours",this.contours);var loader=new AMI.VolumeLoader;loader.on("fetch-start",function(evt){if(evt.file!==_this2.userCase.image.location)return;_this2.fetchProgress=0});loader.on("fetch-progress",function(evt){if(evt.file!==_this2.userCase.image.location)return;_this2.fetchProgress=Math.round(100*evt.loaded/evt.total)});loader.on("fetch-end",function(evt){if(evt.file!==_this2.userCase.image.location)return;_this2.fetchProgress=100});loader.load([userCase.image.location]).then(function(series){var mergedSeries=series[0].mergeSeries(series),firstSeries=mergedSeries[0];return firstSeries}).then(function(series){if("case"!==_this2.routeData.page){throw"page has changed"}if(_this2.userCase.image.location!==series._seriesInstanceUID){throw"volume has changed !"}return series}).then(function(series){var _Mathfloor=Math.floor;_this2.set("series",series);var stack=series.stack[0],stackHelper0=new AMI.StackHelper(stack);stackHelper0.slice.intensityAuto=!1;stackHelper0.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper0.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene0=new THREE.Scene;stackScene0.add(stackHelper0);var stackHelper1=new AMI.StackHelper(stack);stackHelper1.slice.intensityAuto=!1;stackHelper1.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper1.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene1=new THREE.Scene;stackScene1.add(stackHelper1);var stackHelper2=new AMI.StackHelper(stack);stackHelper2.slice.intensityAuto=!1;stackHelper2.slice.windowWidth=_this2.userCase.image.windowWidth;stackHelper2.slice.windowCenter=_this2.userCase.image.windowLevel;var stackScene2=new THREE.Scene;stackScene2.add(stackHelper2);_this2.set("stackScene0",stackScene0);_this2.set("stackScene1",stackScene1);_this2.set("stackScene2",stackScene2);_this2.$.first.orientation="axial";_this2.$.first.resize();_this2.$.second.orientation="coronal";_this2.$.second.resize();_this2.$.third.orientation="sagittal";_this2.$.third.resize();_this2.v0max=_this2.$.first.stackMaxIndex;_this2.stackIndex0=_Mathfloor(_this2.v0max/2);_this2.v1max=_this2.$.second.stackMaxIndex;_this2.stackIndex1=_Mathfloor(_this2.v1max/2);_this2.v2max=_this2.$.third.stackMaxIndex;_this2.stackIndex2=_Mathfloor(_this2.v2max/2);_this2._resetIntensity();_this2.stackWindowWidth=_this2.userCase.image.windowWidth;_this2.stackWindowCenter=_this2.userCase.image.windowLevel;imageLoaded=!0;_this2.fetchProgress=0;_this2.answered=!1;if(imageLoaded){_this2.loadingData=!1;_this2._updateRenderers();if(_this2.userCase.image&&_this2.userCase.image.zoom){if(_this2.userCase.image.zoom.axial){_this2.$.first._camera.zoom=_this2.userCase.image.zoom.axial;_this2.$.first._camera.update()}if(_this2.userCase.image.zoom.coronal){_this2.$.second._camera.zoom=_this2.userCase.image.zoom.coronal;_this2.$.second._camera.update()}if(_this2.userCase.image.zoom.sagittal){_this2.$.third._camera.zoom=_this2.userCase.image.zoom.sagittal;_this2.$.third._camera.update()}}}})}},{key:"_resetIntensity",value:function _resetIntensity(){var stack=this.stackScene0.children[0].stack;this.stackIntensityMin=stack.minMax[0];this.stackIntensityMax=stack.minMax[1];this.stackIntensityRange=stack.minMax[1]-stack.minMax[0];this.stackWindowWidth=this.stackIntensityRange;this.stackWindowCenter=stack.minMax[0]+this.stackIntensityRange/2}},{key:"_resizeListener",value:function _resizeListener(){this.$.first.resize();this.$.second.resize();this.$.third.resize();this._updateRenderers()}},{key:"_submitAnswer",value:function _submitAnswer(){this.$.FBSave.ref.push({id:this.userCase.id,contour:this.contour,choice:this.choice,date:Date.now()});this.contour="";this.choice="";this.answered=!0}},{key:"_selectionDone",value:function _selectionDone(contour,choice){return!(null!==contour&&""!==contour&&null!==choice&&""!==choice)}},{key:"_handleGoto",value:function _handleGoto(event){var ijk=event.detail,stackHelper0=this.stackScene0.children[0],stackHelper1=this.stackScene1.children[0],stackHelper2=this.stackScene2.children[0];this.$.first.stackIndex=ijk.getComponent((stackHelper0.orientation+2)%3);this.$.second.stackIndex=ijk.getComponent((stackHelper1.orientation+2)%3);this.$.third.stackIndex=ijk.getComponent((stackHelper2.orientation+2)%3);this._updateLocalizers();this._updateRenderers()}},{key:"_stackIndexChanged",value:function _stackIndexChanged(index){if(index===void 0){return}this._updateLocalizers();this._updateRenderers()}},{key:"_updateLocalizers",value:function _updateLocalizers(){if(this.stackScene0===void 0||this.stackScene0.children===void 0||this.stackScene1===void 0||this.stackScene1.children===void 0||this.stackScene2===void 0||this.stackScene2.children===void 0){return}var stackHelper0=this.stackScene0.children[0],stackHelper1=this.stackScene1.children[0],stackHelper2=this.stackScene2.children[0],plane0=stackHelper0.slice.cartesianEquation(),plane1=stackHelper1.slice.cartesianEquation(),plane2=stackHelper2.slice.cartesianEquation();this.$.first.localizers=[{plane:plane1,color:new THREE.Color("#607d8b")},{plane:plane2,color:new THREE.Color("#607d8b")}];this.$.second.localizers=[{plane:plane0,color:new THREE.Color("#607d8b")},{plane:plane2,color:new THREE.Color("#607d8b")}];this.$.third.localizers=[{plane:plane0,color:new THREE.Color("#607d8b")},{plane:plane1,color:new THREE.Color("#607d8b")}]}},{key:"_cleanup",value:function _cleanup(){if(null!==this.stackScene0&&this.stackScene0.children&&1<=this.stackScene0.children.length){var stackHelper=this.stackScene0.children[0];this.stackScene0.remove(stackHelper);stackHelper.dispose();stackHelper=null;this.stackScene0={}}if(null!==this.stackScene1&&this.stackScene1.children&&1<=this.stackScene1.children.length){var _stackHelper=this.stackScene1.children[0];this.stackScene1.remove(_stackHelper);_stackHelper.dispose();_stackHelper=null;this.stackScene1={}}if(null!==this.stackScene2&&this.stackScene2.children&&1<=this.stackScene2.children.length){var _stackHelper2=this.stackScene2.children[0];this.stackScene2.remove(_stackHelper2);_stackHelper2.dispose();_stackHelper2=null;this.stackScene2={}}if(this.contours&&0<this.contours.length){for(var i=0;i<this.contours.length;i++){this.contours[i].scene.remove(this.contours[i].meshFront);this.contours[i].meshFront.geometry.dispose();this.contours[i].meshFront.geometry=null;this.contours[i].meshFront.material.dispose();this.contours[i].meshFront.material=null;this.contours[i].meshFront=null;this.contours[i].scene.remove(this.contours[i].meshBack);this.contours[i].meshBack.geometry.dispose();this.contours[i].meshBack.geometry=null;this.contours[i].meshBack.material.dispose();this.contours[i].meshBack.material=null;this.contours[i].meshBack=null;this.set("contours",[])}for(var _i=0;_i<this.userCase.models.length;_i++){this.userCase.models[_i].contour=null}}}},{key:"switchViewer",value:function switchViewer(event){var target=event.currentTarget.getAttribute("target"),viewer=this.$[target].querySelector("ami-viewer-2d");if(null==viewer||viewer==void 0)return;var id=viewer.getAttribute("id");if(null==id||id==void 0)return;if("first"===id)this.set("mainViewer",0);else if("second"===id)this.set("mainViewer",1);else if("third"===id)this.set("mainViewer",2)}},{key:"_mainViewerChanged",value:function _mainViewerChanged(){var target=null;if(0==this.mainViewer)target="first";else if(1==this.mainViewer)target="second";else if(2==this.mainViewer)target="third";if(null==target)return;var elt=this.$[target].parentElement.parentElement.parentElement,id=elt.getAttribute("id");this._changeViewer(id)}},{key:"_changeViewer",value:function _changeViewer(target){var mainContainer=this.$.mainmain.children[2],smallContainer=this.$[target].children[1];this.$.mainmain.appendChild(smallContainer);this.$[target].appendChild(mainContainer);this._resizeListener()}},{key:"toggleMenu",value:function toggleMenu(event){var target=event.currentTarget.getAttribute("target-menu");this.$[target].toggle()}},{key:"toggleControlModal",value:function toggleControlModal(){this.$.modalControls.open()}},{key:"_updateRenderers",value:function _updateRenderers(){this.$.first._changed=!0;this.$.second._changed=!0;this.$.third._changed=!0}},{key:"_todoChanged",value:function _todoChanged(todo){if(todo===void 0){}}},{key:"_done",value:function _done(todo){return 0>=todo.length}},{key:"_next",value:function _next(todo){if(todo===void 0){return}if(0<todo.length){return todo[0].id}}}]);return MyCase}(Polymer.Element);window.customElements.define(MyCase.is,MyCase);</script></dom-module></body></html>